<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‹¨á‹•áˆˆá‰³á‹Š á‰°áŒá‰£áˆ«á‰µ áˆ˜á‰°áŒá‰ áˆªá‹«</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
 <style>
        /* ==============================================================
           === NEW: Loading Screen Styles (áŒ¥á‰áˆ© á‹¨áˆšáˆ½áŠ¨áˆ¨áŠ¨áˆ­ áŒˆáŒ½) ===
           ============================================================== */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #17212b; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999; 
            transition: opacity 0.5s ease-out; 
            opacity: 1;
            /* ğŸ›‘ NEW: á‹³áˆ«á‹ áˆˆáˆµáˆ‹áˆ³ á‰¥áˆ­áˆƒáŠ• áŠ¥áŠ•á‹²á‹«áˆ˜áŠáŒ­ */
            box-shadow: 0 0 100px rgba(255, 193, 7, 0.1) inset;
        }
        
        /* ğŸ›‘ NEW: á‹¨áˆ³áŠ•á‰²áˆ™áŠ• áˆáˆµáˆ á‹­á‰ áˆáŒ¥ á‰†áŠ•áŒ† á‹¨áˆšá‹«á‹°áˆ­áŒˆá‹ CSS */
        #coin-image {
            width: 100px; 
            height: 100px;
            margin-bottom: 20px;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.8), 
                        0 0 30px rgba(255, 215, 0, 0.5); /* Glowing Effect */
            /* ğŸ›‘ NEW: á‹¨3D á‹ˆáˆ­á‰… áŒˆáŒ½á‰³ áˆˆáˆ˜áˆµáŒ á‰µ */
            background: radial-gradient(circle at 60% 30%, #FFD700, #DAA520, #FFD700 80%, #B8860B);
            /* ğŸ›‘ NEW: áŒ áˆ­á‹ áˆ‹á‹­ á‰µáŠ•áˆ½ áŒˆáŒ½á‰³ áˆˆáˆ˜áˆµáŒ á‰µ */
            border: 5px solid #FFECB3; 
        }

        #loading-text {
            /* ğŸ›‘ IMPROVED: áŒ½áˆá‰ áŒáˆá‰¶ áŠ¥áŠ•á‹²á‰³á‹­ */
            color: #FFC107; 
            font-size: 1.4em;
            font-weight: 300; /* Boldest */
            margin-top: 15px;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.7);
            /* ğŸ›‘ NEW: á‹¨áŒ½áˆá á‰¥áˆ­áˆƒáŠ• áŠ¥áŠ•á‹²á‹«áˆ˜áŠáŒ­ */
            animation: pulse-glow 2s infinite alternate; 
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        /* ğŸ›‘ NEW: á‹¨á‰¥áˆ­áˆƒáŠ• áŠ•á‹áˆ¨á‰µ (Pulsating Glow) */
        @keyframes pulse-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 193, 7, 0.5), 0 0 10px rgba(255, 193, 7, 0.3);
            }
            to {
                text-shadow: 0 0 15px #FFC107, 0 0 25px rgba(255, 215, 0, 0.7);
            }
        }
        
        /* ğŸ›‘ NEW: áˆˆáŠ á‹¶á‹á‰½ á‹¨áˆšáŠ•áˆ³áˆá áŠ•á‰…áŠ“á‰„ (Floating Effect) */
        @keyframes icon-float {
            0% { transform: translateY(0); box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
            50% { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7); }
            100% { transform: translateY(0); box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        }

        /* ğŸ›‘ NEW: áˆˆ Luck Slot áŠ á‹¶ á‰¥áˆ­áˆƒáŠ• áˆ›áˆ˜áŠ•áŒ¨á‰µ (Pulsating Glow) */
        @keyframes slot-glow {
            from {
                box-shadow: 0 0 8px rgba(255, 140, 0, 0.7);
            }
            to {
                box-shadow: 0 0 20px #FF8C00, 0 0 30px rgba(255, 215, 0, 0.9);
            }
        }

        .coin-spinner {
            animation: spin 1.5s linear infinite; 
        }
        /* ==============================================================
           === Loading Screen Styles áˆ˜áŒ¨áˆ¨áˆ» ===
           ============================================================== */
           
        /* CSS Styles */
        :root {
            --et-yellow: #FFC107;
            --et-green: #4CAF50;
            --et-purple: #9C27B0;
            --et-red: #F44336;
            --et-blue: #2196F3;
            --tg-bg: var(--tg-theme-bg-color, #1b2129);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #181818);
            --tg-text: var(--tg-theme-text-color, #FFFFFF);
            --tg-hint: var(--tg-theme-hint-color, #AAAAAA);
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-bottom: 70px; 
            overflow-x: hidden;
        }

        #root {
            min-height: calc(100vh - 70px);
            box-sizing: border-box;
            padding: 0 15px 15px 15px;
        }

        /* --- Global Title --- */
        .page-title {
            color: var(--et-yellow);
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding-top: 15px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.5); /* ğŸ›‘ NEW: áˆˆ Title áŒ¥áˆ‹ */
        }
        
        /* ğŸ›‘ NEW: áˆˆ Score Display á‹¨áˆšáˆ†áŠ• áŠ«áˆ­á‹µ */
        .score-card-display {
            text-align: center; 
            font-size: 18px; 
            font-weight: bold; 
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            /* ğŸ›‘ NEW: á‹ˆáˆ­á‰ƒáˆ› ááˆ¬áˆ áŠ¥áŠ“ áŒ¥á‰áˆ­ á‹³áˆ« */
            border: 2px solid var(--et-yellow); 
            background-color: var(--tg-secondary-bg);
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }

        /* --- Task and Card Styling --- */
        .daily-tasks-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }
        .task-button {
            flex: 1 1 30%;
            padding: 15px 5px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            font-size: 14px;
            color: #212121;
            position: relative;
            cursor: pointer;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, opacity 0.1s; /* ğŸ›‘ NEW: áˆˆáˆµáˆ‹áˆ³ áŠ¥áŠ•á‰…áˆµá‰ƒáˆ´ */
        }
        /* ğŸ›‘ NEW: Task Button áˆ²áŒ«áŠ• */
        .task-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .task-button span {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            /* ğŸ›‘ IMPROVED: á‹¨áŒ½áˆá á‰€áˆˆáˆ */
            color: rgba(33, 33, 33, 0.8); 
        }
        .card-button {
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: left;
            border: none;
            width: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); /* ğŸ›‘ IMPROVED: á‹¨á‰°áˆ»áˆˆ á‹¨áŒ¥áˆ‹ áŒˆáŒ½á‰³ */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        /* ğŸ›‘ NEW: Card Button áˆ²áŒ«áŠ•/ áˆ²áŠáŠ« */
        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }
        .card-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        /* ğŸ›‘ NEW: Cooldown Style for Cards */
        .card-button.cooldown-style {
            opacity: 0.6; /* ğŸ›‘ IMPROVED: á‹­á‰ áˆáŒ¥ áŒáˆá‰¶ áŠ¥áŠ•á‹²á‰³á‹­ */
            /* pointer-events: none; - á‰ JS á‰°áˆµá‰°áŠ«áŠ­áˆáˆ */
        }

        .card-icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* ğŸ›‘ NEW: áˆˆáŠ á‹¶ áŒ¥áˆ‹ */
            /* âœ… NEW: á‹¨áˆ˜áŠ•áˆ³áˆá áŠ•á‰…áŠ“á‰„ */
            animation: icon-float 2s infinite alternate ease-in-out; 
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        /* ğŸ›‘ NEW: áˆˆ "Day Spin" áŠ á‹¶ áˆá‹© á‹˜á‹­á‰¤ */
        .card-icon-circle.daily-spin-icon {
            /* á‹¨ Day Spin áŠ á‹¶á‹ áŠ¥áŠ•á‹²áˆ½áŠ¨áˆ¨áŠ¨áˆ­ áŠ¥áŠ“ áŠ¥áŠ•á‹²áŠ•áˆ³áˆá á‹«á‹°áˆ­áŒ‹áˆ */
            background-color: var(--et-purple); 
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.8);
            animation: spin 1.5s linear infinite, icon-float 2s infinite alternate ease-in-out; 
        }

        /* ğŸ›‘ NEW: áˆˆ "Luck Slot" áŠ á‹¶ áˆá‹© á‹˜á‹­á‰¤ */
        .card-icon-circle.luck-slot-icon {
            /* á‹¨ Luck Slot áŠ á‹¶á‹ á‰ á‰¥áˆ­á‰± áŠ¥áŠ•á‹²á‹«áŠ•áŒ¸á‰£áˆ­á‰… áŠ¥áŠ“ áŠ¥áŠ•á‹²áŠ•áˆ³áˆá á‹«á‹°áˆ­áŒ‹áˆ */
            background-color: #FF8C00; /* Darker Orange */
            border: 2px solid var(--et-yellow);
            font-size: 28px; 
            animation: slot-glow 3s infinite alternate, icon-float 2s infinite alternate ease-in-out;
        }

        .card-text-container {
            flex-grow: 1;
            margin-right: 10px; 
        }
        .card-title {
            font-size: 16px;
            font-weight: bold;
        }
        .card-subtitle {
            font-size: 12px;
            color: var(--tg-hint);
        }

        /* ğŸ›‘ NEW BADGE STYLES */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
            margin-left: auto;
            transition: background-color 0.3s, box-shadow 0.3s; /* ğŸ›‘ NEW */
        }
        .status-badge.ready {
            background-color: var(--et-green); 
            color: white;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.7); /* ğŸ›‘ IMPROVED: á‹¨áˆšá‹«á‰ áˆ« Ready */
        }
        .status-badge.cooldown {
            background-color: var(--et-red); 
            color: white;
        }

        .arrow-icon {
            font-size: 24px;
            color: var(--et-yellow);
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        /* =========================================================
           ğŸ›‘ NEW: Social Tasks Styles
           ========================================================= */
        .social-tasks-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--tg-text);
            margin-bottom: 5px;
        }
        .social-tasks-subtitle {
            font-size: 14px;
            color: var(--tg-hint);
            margin-bottom: 20px;
        }
        .social-task-card {
            background-color: #242424; /* áŒ¥á‰áˆ­ á‹³áˆ« áŠ¨áˆáˆµáˆ‰ áŒ‹áˆ­ áŠ¥áŠ•á‹²áˆ˜áˆ³áˆ°áˆ */
            padding: 15px;
            border-radius: 15px; /* á‹¨á‰°áŒ áŒ‹áŒ‹ áŒ áˆ­á‹ */
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        .social-task-icon-container {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            /* âœ… NEW: á‹¨áˆ˜áŠ•áˆ³áˆá áŠ•á‰…áŠ“á‰„ */
            animation: icon-float 2s infinite alternate ease-in-out; 
        }
        .social-task-text-container {
            flex-grow: 1;
        }
        .social-task-title {
            font-weight: bold;
            font-size: 16px;
            color: white;
            margin-bottom: 3px;
        }
        .social-task-reward {
            font-size: 14px;
            color: var(--et-yellow); 
            font-weight: bold;
        }
        .social-task-action-button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .social-task-action-button.join-style {
            background-color: var(--et-blue); 
            color: white;
            box-shadow: 0 3px 0 #1565C0;
        }
        .social-task-action-button.join-style:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #1565C0;
        }
        .social-task-action-button.completed-style {
            background-color: #555;
            color: var(--tg-text);
            cursor: not-allowed;
        }
        .social-task-action-button .check-icon {
            margin-left: 5px;
            font-size: 16px;
            color: var(--et-yellow);
        }

        /* =========================================================
           ğŸ›‘ NEW: Daily Reward Modal Styles (á‰ áˆáˆµáˆ‰ áˆ˜áˆ°áˆ¨á‰µ á‹¨á‰°áˆ°áˆ«)
           ========================================================= */
        #daily-reward-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none; /* á‰  JS á‹­áŠ¨áˆá‰³áˆ */
            align-items: center;
            justify-content: center;
        }

        .reward-content {
            background-color: var(--tg-bg);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }
        
        .reward-content h2 {
            margin-top: 0;
            color: var(--et-yellow);
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .reward-content p {
            font-size: 14px;
            color: var(--tg-hint);
            margin-bottom: 20px;
        }

        .reward-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .reward-day-card {
            background-color: var(--tg-secondary-bg);
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .reward-day-card.claimed {
            background-color: #333;
            border-color: var(--et-green);
        }

        .reward-day-card.active-ready {
            background-color: var(--et-purple); /* áˆáˆµáˆ‰ áˆ‹á‹­ áŠ¥áŠ•á‹³áˆˆá‹ */
            border-color: var(--et-yellow);
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        
        .reward-day-card.active-ready:active {
            transform: translateY(2px);
        }
        
        .reward-day-card span {
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
            color: var(--et-yellow);
        }
        
        .reward-day-card.claimed span {
            color: var(--tg-hint);
            text-decoration: line-through;
        }

        .reward-coin-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle at 60% 30%, #FFD700, #DAA520, #FFD700 80%, #B8860B);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 900;
            color: #444;
            box-shadow: 0 0 5px rgba(255, 193, 7, 0.8);
            margin-bottom: 3px;
        }

        #daily-reward-claim-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background-color: var(--et-green);
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 0 #388E3C;
            transition: all 0.1s ease;
        }
        
        #daily-reward-claim-button:disabled {
            background-color: #555;
            box-shadow: 0 4px 0 #333;
            cursor: not-allowed;
        }

        #daily-reward-claim-button:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #388E3C;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--tg-hint);
            font-size: 24px;
            cursor: pointer;
        }


        /* =========================================================
           ğŸ›‘ NEW: Social Tasks Styles áˆ˜áŒ¨áˆ¨áˆ»
           ========================================================= */

/* ====================================================================== */
/* === GLOBAL & THEME VARIABLES === */
/* ====================================================================== */
:root {
    /* á‰¥áŒ á‰€áˆˆáˆá‰½ */
    --et-blue: #1976D2;          /* áˆ°áˆ›á‹«á‹Š */
    --et-yellow: #FFC300;        /* á‹‹áŠ“ á‰¢áŒ« áŠ áŠ­áˆ°áŠ•á‰µ (Gold) */
    --et-yellow-dark: #cc9c00;   /* áˆˆáŒ¥áˆ‹ (Shadow) */
    --et-red: #F44336;           /* á‰€á‹­ */
    --et-green: #4CAF50;         /* áŠ áˆ¨áŠ•áŒ“á‹´ */
    
    /* á‹³áˆ« áŠ¥áŠ“ á…áˆá (áŠ¨á‰´áˆŒáŒáˆ«áˆ áŒ­á‰¥áŒ¥ áŒ‹áˆ­ á‹¨áˆšáˆµáˆ›áˆ›) */
    --bg-primary: #121212;       /* áŒ¥áˆá‰… áŒ¥á‰áˆ­ á‹³áˆ« */
    --bg-card: #2B2B2B;          /* á‹¨áŠ«áˆ­á‹µ á‹³áˆ« */
    --text-light: #F0F0F0;       /* á‰€áˆ‹áˆ á‹¨á…áˆá á‰€áˆˆáˆ */
    --text-grey: #A0A0A0;        /* áŒáˆ«áŒ«áˆ› á‹¨á…áˆá á‰€áˆˆáˆ */
    --shadow-dark: rgba(0, 0, 0, 0.7); /* áŒ¥áˆá‰… áŒ¥áˆ‹ */

    /* === áˆˆáŠ áŠ’áˆœáˆ½áŠ• áŠ á‹²áˆµ á‰°áˆˆá‹‹á‹‹áŒ®á‰½ === */
    --glow-color: var(--et-yellow);
    --glow-secondary: rgba(255, 195, 0, 0.15); /* á‰µáŠ•áˆ½ á‹°á‰¥á‹›á‹› á‰¢áŒ« */
}

/* ====================================================================== */
/* === KEYFRAMES FOR ANIMATION (áŠ á‹²áˆµ á‹¨á‰°áŒ¨áˆ˜áˆ¨) === */
/* ====================================================================== */
@keyframes spinBorder {
    0% {
        box-shadow: 0 0 0 2px var(--glow-secondary), 0 0 15px var(--glow-color);
        border-color: var(--glow-color); /* áŒ áŠ•áŠ«áˆ« á‰¥áˆ­áˆƒáŠ• */
    }
    50% {
        box-shadow: 0 0 0 0px var(--glow-secondary), 0 0 5px var(--glow-secondary);
        border-color: var(--glow-secondary); /* á‹°á‰¥á‹˜á‹ á‹«áˆˆ á‰¥áˆ­áˆƒáŠ• */
    }
    100% {
        box-shadow: 0 0 0 2px var(--glow-secondary), 0 0 15px var(--glow-color);
        border-color: var(--glow-color);
    }
}


/* ====================================================================== */
/* === BASE STYLES & LAYOUT === */
/* ====================================================================== */
/* á‹¨áŒ‹áˆ« á‰°áˆˆá‹‹á‹‹áŒ®á‰½ (Variables) */
{
    background-color: var(--bg-primary); 
    color: var(--text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 20px; /* áˆˆáŠ®á‹± áˆ›áˆ³á‹« */
}

/* ====================================================================== */
/* === INVITE CARD STYLES (Glow Animation á‹¨á‰°áŒ¨áˆ˜áˆ¨á‰ á‰µ) === */
/* ====================================================================== */
.invite-card-container {
    /* áŠ«áˆ­á‹±áŠ• á‰ áˆ˜áˆƒáˆ áˆˆáˆ›á‹µáˆ¨áŒ á‰ áˆ™áˆ‰ HTML á‹áˆµáŒ¥ á‹¨áŠá‰ áˆ¨á‹áŠ• `invite-card-container` áŠ­ááˆ á‹­áŒ á‰€áˆ™ */
    padding: 0; 
}

/* á‹¨áŠ«áˆ­á‹± á‹‹áŠ“ áˆ˜á‹«á‹£ */
.invite-card {
    background-color: var(--bg-card); 
    padding: 10px;
    border-radius: 18px; /* áˆˆáˆµáˆˆáˆµ á‹«áˆˆ á‹¨á‰°áŒ áŒ‹áŒ‹ áŒ áˆ­á‹ */
    box-shadow: 0 8px 30px var(--shadow-dark); /* á‹­á‰ áˆáŒ¥ áŒáˆá‰¶ áŠ¥áŠ•á‹²á‹ˆáŒ£ áŒ¥áˆá‰… áŒ¥áˆ‹ */
    width: 330px;
    max-width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px; /* á‰  header áŠ¥áŠ“ button áˆ˜áŠ«áŠ¨áˆ á‰µáˆá‰… áŠ­áá‰°á‰µ */
    
    /* === áˆˆ Animation áŠ¥áŠá‹šáˆ… áˆáˆˆá‰µ áˆ˜áˆµáˆ˜áˆ®á‰½ á‰¥á‰» á‰°áŒ¨áˆáˆ¨á‹‹áˆ === */
    border: 2px solid var(--glow-secondary); /* á‹¨ Border áˆµá‰³á‹­áˆáŠ• á‹ˆá‹° 2px áŠ á‹µáˆ­áŒˆáŠ“áˆ */
    animation: spinBorder 2.5s infinite alternate ease-in-out; /* áŠ á‹²áˆµ áŠ áŠ’áˆœáˆ½áŠ• */
  margin-bottom:20px;
}

/* á‹¨áˆ‹á‹­áŠ›á‹ áŠ­ááˆ (áŠ á‹­áŠ®áŠ• áŠ¥áŠ“ á…áˆáá‰½) */
.header-section {
    display: flex;
    align-items: center;
}

.icon-circle {
    background-color: var(--et-yellow); 
    color: var(--bg-card); 
    width: 48px; /* á‰µáˆá‰… áŠ á‹­áŠ®áŠ• */
    height: 48px;
    border-radius: 12px; /* áŠ«áˆ¬á£ á‹¨á‰°áŒ áŒ‹áŒ‹ áŒ áˆ­á‹ á‹«áˆˆá‹ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px; /* á‰µáˆá‰… ááŠ•á‰µ */
    font-weight: 900; /* á‰ áŒ£áˆ á‹¨á‹°áˆ˜á‰€ */
    margin-right: 15px;
    box-shadow: 0 0 10px rgba(255, 195, 0, 0.5); /* á‹¨á‰¢áŒ«á‹ á‰¥áˆ­áˆƒáŠ• */
}

.title {
    font-size: 17px;
    font-weight: 700;
    margin: 0;
    color: var(--text-light);
}

.subtitle {
    font-size: 12px;
    margin: 4px 0 0 0;
    color: var(--text-grey); 
    line-height: 1.4;
    font-style: italic; /* áˆˆáˆµáˆˆáˆµ á‹«áˆˆ áŒ½áˆ‘á */
}

/* ====================================================================== */
/* === BUTTONS SECTION === */
/* ====================================================================== */
.button-row {
    display: flex;
    gap: 12px; /* á‰ á‰áˆáá‰¹ áˆ˜áŠ«áŠ¨áˆ á‹«áˆˆ áŠ­áá‰°á‰µ á‹­áŒ¨áˆáˆ«áˆ */
}

/* --- INVITE BUTTON (3D EFFECT) --- */
.invite-button {
    text-decoration: none; /* áˆˆ <a> tag */
    width: 100%;
    height: 45px; /* á‰áˆ˜á‰±áŠ• á‹­áŒ¨áˆáˆ«áˆ */
    padding: 0 15px;
    border: none;
    border-radius: 12px;
    background-color: var(--et-yellow); 
    color: var(--bg-card); 
    font-weight: 800;
    font-size: 16px;
    cursor: pointer;
    
    /* 3D/Raised Effect */
    box-shadow: 0 5px 0 var(--et-yellow-dark); 
    transition: all 0.15s ease;
    
    display: flex;
    align-items: center;
    justify-content: center;
    flex-grow: 1;
    text-transform: uppercase; /* áŠá‹°áˆ‰áŠ• áŠ¨á á‹«á‹°áˆ­áŒ‹áˆ */
}

.invite-button:active {
    box-shadow: 0 2px 0 var(--et-yellow-dark);
    transform: translateY(5px); /* áˆ²áŒ«áŠ• á‹¨áŒ¥áˆ‹á‹ áˆ˜áŒ áŠ• á‹«áˆ…áˆ á‹­áŒˆá‰£áˆ */
}

/* --- COPY BUTTON (SQUARE, 3D EFFECT) --- */
.copy-button {
    background-color: #3A3A3A; /* áŒ¥á‰áˆ­ áŒáˆ«áŒ« á‹³áˆ« */
    border: none; 
    width: 55px; /* áŠ¨á‹‹áŠ“á‹ á‰áˆá áŒ‹áˆ­ á‰áˆ˜á‰µ áŠ¥áŠ•á‹²áˆ˜áˆ³áˆ°áˆ */
    height: 55px; 
    border-radius: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.15s ease;
    
    /* 3D/Raised Effect */
    box-shadow: 0 7px 0 #202020; /* áŠ¨áŒ¨áˆˆáˆ› á‹³áˆ« áŒ‹áˆ­ á‹¨áˆšáˆ˜áˆ³áˆ°áˆ áŒ¥áˆá‰… áŒ¥áˆ‹ */
}

.copy-button:active {
    transform: translateY(5px); 
    box-shadow: 0 2px 0 #202020;
}
        
.copy-icon {
    width: 26px; 
    height: 26px;
    color: var(--et-yellow); /* áŠ á‹­áŠ®áŠ‘áŠ• á‰¢áŒ« á‹«á‹°áˆ­áŒˆá‹‹áˆ */
    stroke-width: 2.5; /* áŠ á‹­áŠ®áŠ‘áŠ• á‹°áˆ˜á‰… á‹«á‹°áˆ­áŒˆá‹‹áˆ */
}


.mystery-text {
    flex-grow: 1;
    margin-left: 15px;
}
.mystery-status {
    background-color: var(--et-green);
    color: var(--bg-primary);
    padding: 5px 10px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 12px;
}
/* ... (áˆŒáˆá‰½ áŠ áˆµáˆáˆ‹áŒŠ áˆµá‰³á‹­áˆá‰½) ... */



 /* ====================================================================== */
/* === NAVIGATION BAR STYLES (áˆáŠ­ áŠ¥áŠ•á‹° áˆáˆµáˆ‰ á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆ) === */
/* ====================================================================== */
#nav-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    
    /* á‰áˆ˜á‰µ áŠ¥áŠ“ á‹³áˆ« (Background) */
    height: 60px;
    background-color: #202c33; /* ğŸ›‘ NEW: áŠ¥áŠ•á‹° áˆáˆµáˆ‰ áŒ¥á‰áˆ­-áˆ°áˆ›á‹«á‹Š á‹³áˆ« */
    
    display: flex;
    justify-content: space-around;
    align-items: center;
    
    border-top: 1px solid #1a2227; /* á‰€áŒ­áŠ• á‹¨áˆ‹á‹­áŠ›á‹ á‹µáŠ•á‰ áˆ­ */
    box-shadow: 0 -5px 10px var(--shadow-dark); 
    z-index: 1000;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    
    /* á‹¨áˆáˆ‰áˆ áŠ•áŒ¥áˆá‰½ (Items) á‰€áˆˆáˆ áŒáˆ«áŒ« */
    color: var(--text-grey); 
    
    font-size: 11px;
    width: 25%; /* á‰ áˆáˆµáˆ‰ áˆ‹á‹­ áŠ áˆ«á‰µ áŠ•áŒ¥áˆá‰½ áŠ áˆ‰ */
    height: 100%;
    transition: color 0.3s;
}

/* ğŸ›‘ NEW: áŠ•á‰ á‹¨áˆ†áŠá‹áŠ• áŠ á‹¶ áŠ­á‰¥ áŠ¥áŠ•á‹²áŠ–áˆ¨á‹ áˆˆáˆ›á‹µáˆ¨áŒ */
.nav-icon-container {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2px;
    transition: background-color 0.3s;
}

.nav-item.active .nav-icon-container {
    /* ğŸ›‘ NEW: áŠ•á‰ áˆ²áˆ†áŠ• áˆ°áˆ›á‹«á‹Š á‹³áˆ« (Circle Background) */
    background-color: #5d93bb; 
}

.nav-icon {
    font-size: 20px;
    /* ğŸ›‘ NEW: á‹¨áŠ á‹¶á‹á‰¹ á‰€áˆˆáˆ á‰ áŠá‰£áˆª áŠáŒ­ (text-light) á‹­áˆ†áŠ“áˆ */
    color: var(--text-light); 
}

.nav-item.active {
    /* áŠ•á‰ áŒ½áˆá (Active Text) áˆ°áˆ›á‹«á‹Š á‹­áˆ†áŠ“áˆ */
    color: #5d93bb; 
    text-shadow: none; /* á‰¥áˆ­áˆƒáŠ‘áŠ• áŠ áˆµá‹ˆáŒá‹°áŠ“áˆ */
}

/* --- Top Page (Leaderboard) --- */
        .top-user-card {
            background-color: var(--tg-secondary-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); /* ğŸ›‘ IMPROVED: áŒ¥áˆá‰… áŒ¥áˆ‹ */
            /* ğŸ›‘ IMPROVEMENT: á‹ˆáˆ­á‰ƒáˆ› ááˆ¬áˆ áˆˆá‹‹áŠ“á‹ áŠ«áˆ­á‹µ */
            border: 2px solid var(--et-yellow); 
        }
        .top-user-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .stat-item {
            padding: 3px;
            border-radius: 8px;
            background-color: #333;
            flex-basis: 45%;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3) inset; /* ğŸ›‘ NEW: á‹¨3D áŒˆáŒ½á‰³ */
        }
        .stat-item span {
            display: block;
            font-size: 12px;
            color: var(--tg-hint);
            margin-top: 3px;
        }
        #leaderboard-list {
            background-color: var(--tg-secondary-bg);
            padding: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); /* ğŸ›‘ IMPROVED: áŒ¥áˆá‰… áŒ¥áˆ‹ */
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #2a2a2a;
            transition: background-color 0.2s; /* ğŸ›‘ NEW */
        }
        
        /* ğŸ›‘ NEW/IMPROVEMENT: áˆˆ Top 3 á‹¨áŒ€áˆ­á‰£ á‰€áˆˆáˆ áˆ›á‹µáˆ˜á‰‚á‹« */
        .leaderboard-item.gold-highlight {
            background-color: rgba(255, 215, 0, 0.15); /* á‰€áˆ‹áˆ á‹ˆáˆ­á‰ƒáˆ› */
            border-left: 4px solid #FFD700;
        }
        .leaderboard-item.silver-highlight {
            background-color: rgba(192, 192, 192, 0.15); /* á‰€áˆ‹áˆ á‰¥áˆ­áˆ› */
            border-left: 4px solid #C0C0C0;
        }
        .leaderboard-item.bronze-highlight {
            background-color: rgba(205, 127, 50, 0.15); /* á‰€áˆ‹áˆ áŠáˆáˆ³áˆ› */
            border-left: 4px solid #CD7F32;
        }

        .leaderboard-item-rank {
            font-weight: bold;
            width: 35px; /* á‰¦á‰³á‹áŠ• áˆ˜áŒ¨áˆ˜áˆ­ */
            text-align: center;
            color: var(--tg-text);
            font-size: 16px;
        }
        /* ğŸ›‘ NEW/IMPROVEMENT: áˆˆ Top 3 á‹°áˆ¨áŒƒá‹á‰½ áˆá‹© á‰€áˆˆáˆ áŠ¥áŠ“ áˆ˜áŒ áŠ• */
        .leaderboard-item-rank.gold {
            color: #FFD700; /* á‹ˆáˆ­á‰… */
            font-size: 20px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
        }
        .leaderboard-item-rank.silver {
            color: #C0C0C0; /* á‰¥áˆ­ */
            font-size: 18px;
        }
        .leaderboard-item-rank.bronze {
            color: #CD7F32; /* áŠáˆáˆµ */
            font-size: 17px;
        }

        .leaderboard-item-photo { 
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--et-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            overflow: hidden; 
            flex-shrink: 0;
            border: 2px solid #555; /* ğŸ›‘ NEW: áˆˆáá‰¶ á‰µáŠ•áˆ½ ááˆ¬áˆ */
        }
        .leaderboard-item-name {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            /* ğŸ›‘ IMPROVEMENT: áˆ¨áŒ…áˆ áˆµáˆá‰½ áŠ¥áŠ•á‹³á‹­á‹ˆáŒ¡ áˆ˜áŠ¨áˆ‹áŠ¨áˆ */
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
            margin-right: 10px; 
        }
        .leaderboard-item-score {
            font-weight: bold;
            color: var(--et-green);
            white-space: nowrap;
            font-size: 15px;
            text-shadow: 0 0 3px rgba(76, 175, 80, 0.5); /* ğŸ›‘ NEW: áˆˆáŠáŒ¥á‰¥ áŒ¥áˆ‹ */
        }
        .current-user-highlight {
            background-color: rgba(76, 175, 80, 0.3); /* ğŸ›‘ IMPROVED: á‹¨áŒ á‰†áˆ¨ á‹³áˆ« */
            border-left: 4px solid var(--et-green); 
            font-weight: bold; /* ğŸ›‘ NEW: áŒáˆ‹ á‰¥áˆ áŠ¥áŠ•á‹²á‰³á‹­ */
        }

        /* --- Profile Page Styling --- */
        #profile-page {
            text-align: center;
            padding-top: 40px;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            background-color: var(--et-green);
            border-radius: 50%;
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: bold;
            /* ğŸ›‘ NEW: áˆˆ Profile Avatar áŒ¥áˆ‹ */
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            border: 4px solid white; 
            overflow: hidden; 
        }
        .profile-username-display {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--et-yellow); /* ğŸ›‘ IMPROVED: á‹ˆáˆ­á‰ƒáˆ› á‰€áˆˆáˆ */
        }
        .profile-stat-box {
            background-color: var(--tg-secondary-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* ğŸ›‘ NEW */
        }
        .stat-label {
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        .stat-label .icon {
            margin-right: 10px;
            font-size: 20px;
            color: var(--et-yellow);
        }
        .balance-value {
            font-weight: bold;
            color: var(--et-green);
            text-shadow: 0 0 3px rgba(76, 175, 80, 0.5); 
        }
        .withdraw-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--et-green);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .withdraw-button:hover {
            background-color: #388E3C;
        }
        .profile-action-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: left;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* ğŸ›‘ NEW */
            transition: transform 0.2s, box-shadow 0.2s;
        }
         .profile-action-button:hover {
            transform: translateX(5px); /* ğŸ›‘ NEW: áˆ²áŠáŠ« áŠ¥áŠ•á‹²áŠ•á‰€áˆ³á‰€áˆµ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .profile-action-button .icon {
            margin-right: 15px;
            font-size: 20px;
        }
        .exchange-status {
            color: var(--tg-hint);
            font-size: 14px;
            margin-right: 10px;
        }

        /* --- Game Page Styles --- */
        .game-page-container {
            padding: 20px 10px;
            text-align: center;
        }
        .game-page-container h2 {
            margin-bottom: 20px;
            color: var(--et-yellow);
            font-size: 22px;
            text-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
        }
        .game-info-box {
            background-color: var(--tg-secondary-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5); /* ğŸ›‘ IMPROVED */
        }
        .game-action-button {
            display: block;
            width: 80%;
            margin: 20px auto;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--et-green);
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 6px 0 #388E3C; /* ğŸ›‘ IMPROVED */
            transition: all 0.1s ease;
        }
        .game-action-button:active {
            box-shadow: 0 2px 0 #388E3C;
            transform: translateY(4px); /* ğŸ›‘ IMPROVED */
        }
        .game-action-button.cooldown {
             background-color: #555;
             box-shadow: 0 6px 0 #333;
             cursor: not-allowed;
        }
        .game-back-button {
            display: block;
            width: 80%;
            margin: 40px auto 10px auto;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #424242;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .game-back-button:hover {
            background-color: #555555;
        }
        .cooldown-timer {
            font-size: 20px;
            font-weight: bold;
            color: var(--et-red);
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(244, 67, 54, 0.5); /* ğŸ›‘ NEW */
        }
        
        /* =========================================================
           --- Daily Spin Wheel Styles ---
           ========================================================= */
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 30px auto;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 5px solid var(--et-yellow);
            background-color: transparent; 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); /* ğŸ›‘ NEW: áˆˆ Wheel á‰¥áˆ­áˆƒáŠ• */
        }
        .segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 0;
            left: 0;
            transform-origin: 100% 100%;
            clip-path: polygon(0 0, 100% 100%, 0 100%);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow: hidden;
        }
        .segment-content {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .segment-text {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 12px; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8); /* á‹¨áŒ¥áˆ‹ áˆµá‰³á‹­áˆ */
            
            /* === ğŸ›‘ áŠ á‹²áˆ± á‰µáŠ­áŠ­áˆˆáŠ› áˆ˜áá‰µáˆ” === */
            
            width: 70px; /* á‹¨áŒ½áˆá‰ áˆµá‹á‰µ */
            text-align: center;
            line-height: 1.1;
            white-space: normal;

            /* 1. áŒ½áˆá‰áŠ• áŠ¨áˆ³áŒ¥áŠ‘ áˆ‹á‹­áŠ›á‹ áŒ áˆ­á‹ 60px á‹ˆá‹°á‰³á‰½á£ áŠ¨áŒáˆ« 10px á‹ˆá‹°á‰€áŠ á‰ áˆ›áˆµá‰€áˆ˜áŒ¥
                á‰ áˆšá‰³á‹¨á‹ á‰µáˆªá‹«áŠ•áŒáˆ á‹áˆµáŒ¥ áŠ¥áŠ•á‹²áˆ†áŠ• áŠ¥áŠ“á‹°áˆ­áŒ‹áˆˆáŠ•á¢
            */
            top: 60px; 
            left: 10px;
            
            /* 2. áŒ½áˆá‰ áŠ¨áˆ³áŒ¥áŠ‘ (segment) áŒ‹áˆ­ áŠ¥áŠ•á‹²áˆµá‰°áŠ«áŠ¨áˆ á‰ 18 á‹²áŒáˆª áŠ¥áŠ“á‹áˆ¨á‹‹áˆˆáŠ•á¢
                'transform-origin' áŒ½áˆá‰ áŠ¨áˆ«áˆ± á‹¨áˆ‹á‹­áŠ›á‹ áŒáˆ« áŒ áˆ­á‹ á‰°áŠáˆµá‰¶ áŠ¥áŠ•á‹²á‹áˆ­ á‹«á‹°áˆ­áŒ‹áˆá¢
            */
            transform-origin: top left;
            transform: rotate(28deg); 
        }


.pointer {
            position: absolute;
            top: 5px; 
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent; /* ğŸ›‘ IMPROVED: á‰µáˆá‰… áŠ¥áŠ•á‹²áˆ†áŠ• */
            border-right: 15px solid transparent; /* ğŸ›‘ IMPROVED: á‰µáˆá‰… áŠ¥áŠ•á‹²áˆ†áŠ• */
            border-bottom: 25px solid var(--et-red); /* ğŸ›‘ IMPROVED: á‰µáˆá‰… áŠ¥áŠ•á‹²áˆ†áŠ• */
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(244, 67, 54, 0.8)); /* ğŸ›‘ NEW: áˆˆ Pointer áŒ¥áˆ‹ */
        }

        /* =========================================================
           --- Daily Spin Wheel Styles áˆ˜áŒ¨áˆ¨áˆ» ---
           ========================================================= */


        /* --- Mystery Box Styles --- */
        .box-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .mystery-box {
            width: 90px; /* ğŸ›‘ IMPROVED: á‰µáˆá‰… áŠ¥áŠ•á‹²áˆ†áŠ• */
            height: 90px; /* ğŸ›‘ IMPROVED: á‰µáˆá‰… áŠ¥áŠ•á‹²áˆ†áŠ• */
            background-color: var(--et-red);
            border-radius: 12px; /* ğŸ›‘ IMPROVED: á‰µáŠ•áˆ½ áŠ­á‰¥ á‰…áˆ­áŒ½ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px; /* ğŸ›‘ IMPROVED: á‰µáˆá‰… á‰…áˆ­áŒ¸-á‰áˆáŠ */
            cursor: pointer;
            transition: transform 0.2s, background-color 0.5s;
            box-shadow: 0 8px 0 #A83232; /* ğŸ›‘ IMPROVED: áŒ¥áˆá‰… áŒ¥áˆ‹ */
        }
        .mystery-box:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #A83232;
        }
        .mystery-box.opened {
            background-color: var(--et-green);
            box-shadow: 0 8px 0 #388E3C;
        }
        .mystery-box.missed {
            background-color: #666; /* ğŸ›‘ IMPROVED: á‹¨áŒ á‰†áˆ¨ áŒáˆ«áŒ« */
        }
        
        /* --- Reflex Game Styles --- */
        #reflex-play-area {
            height: 200px;
            background-color: var(--tg-secondary-bg);
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-hint);
            cursor: pointer; 
            border: 2px dashed var(--et-yellow); /* ğŸ›‘ NEW: áˆˆáŒ¨á‹‹á‰³á‹ á‰¦á‰³ áŒ áˆ­á‹ */
        }
        #reflex-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: var(--et-red);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 7px 0 #882222;
            transition: transform 0.1s;
        }
        #reflex-button:active {
            transform: translateY(3px);
            box-shadow: 0 4px 0 #882222;
        }
        
       /* ============================================== */
        /* âœ… ğŸ›‘ áŠ á‹²áˆµ: Scratch Card Game Styles */
        /* ============================================== */
        
        /* á‹­áˆ… áˆ˜á‹«á‹£ (container) áˆ½áˆáˆ›á‰±áŠ• áŠ¥áŠ“ áˆ˜áˆá‰…áˆá‰‚á‹«á‹áŠ• áŠ¥áŠ•á‹²á‹°áˆ«áˆ¨á‰¡ á‹«á‹°áˆ­áŒ‹áˆ */
        #scratch-card-container {
            position: relative;
            width: 280px; /* á‹¨áˆ˜áˆá‰…áˆá‰‚á‹«á‹ áˆµá‹á‰µ */
            height: 150px; /* á‹¨áˆ˜áˆá‰…áˆá‰‚á‹«á‹ á‰áˆ˜á‰µ */
            margin: 20px auto 0 auto;
            border-radius: 10px;
            overflow: hidden; /* áŠ¨áŠ­á‰¥ áŒ áˆ­á‹™ á‹áŒª áŠ¥áŠ•á‹³á‹­á‰³á‹­ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            background-color: var(--tg-secondary-bg); /* áŠ¨áˆµáˆ­ á‹«áˆˆá‹ á‹³áˆ« */
        }

        /* 1. áŠ¨á‰³á‰½ á‹«áˆˆá‹ á‹¨áˆ½áˆáˆ›á‰µ áŒ½áˆá */
        .scratch-prize-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* áˆˆáˆ½áˆáˆ›á‰± á‹¨áˆšá‹«áˆáˆ­ áŒ½áˆá */
            font-size: 32px;
            font-weight: 900;
            color: var(--et-green);
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
            
            /* á‰°áŒ á‰ƒáˆšá‹ áŒ½áˆá‰áŠ• áŠ¥áŠ•á‹³á‹­áˆ˜áˆ­áŒ á‹ (select) áˆ›á‹µáˆ¨áŒ */
            user-select: none; 
            -webkit-user-select: none;
        }
        
        /* 2. áŠ¨áˆ‹á‹­ á‹«áˆˆá‹ áˆ˜áˆá‰…áˆá‰‚á‹« (Canvas) */
        .scratch-top-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* áŠ¨áˆ½áˆáˆ›á‰± áŒ½áˆá á‰ áˆ‹á‹­ áŠ¥áŠ•á‹²áˆ†áŠ• */
            
            /* á‹¨áˆ˜áˆá‰…áˆá‰‚á‹« áŠ á‹­áŒ¥ áˆáˆáŠ­á‰µ (cursor) */
            cursor: grab; 
        }

        .scratch-top-layer:active {
            cursor: grabbing;
        }

 
        /* ============================================== */
        /* âœ… Slot Game CSS */
        /* ============================================== */
        .game-page-container {
            padding: 15px;
            text-align: center;
        }

        .daily-game-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 20px 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
        }

        .daily-game-card .header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 15px;
        }

        .daily-game-card .header .back-button {
            position: absolute;
            left: 0;
            font-size: 24px;
            color: var(--tg-hint);
            cursor: pointer;
            padding: 5px;
        }

        .daily-game-card .header .main-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--et-yellow);
        }

        .daily-game-card .header .sub-title {
            font-size: 14px;
            color: var(--tg-hint);
            text-align: center;
            margin-top: 5px;
        }

        .info-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }

        .info-item {
            font-size: 14px;
            color: var(--tg-text);
            font-weight: 500;
        }

        .info-item span {
            font-weight: bold;
            color: var(--et-yellow);
            display: block;
            font-size: 18px;
        }

        .slots-area {
            display: flex;
            justify-content: space-around;
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 3px solid #3d3d3d;
        }

        .slot {
            width: 30%;
            height: 80px;
            background-color: #000000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.2);
            overflow: hidden; 
        }

        .daily-game-card .btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            color: white;
            text-transform: uppercase;
        }

        #spin-btn {
            background-color: var(--et-red);
            box-shadow: 0 4px #911a1a; /* Darker red for shadow */
        }

        #claim-btn {
            background-color: #6d6d6d;
            box-shadow: 0 4px #575757;
        }

        #claim-btn:not([disabled]) {
            background-color: var(--et-green);
            box-shadow: 0 4px #006000; /* Darker green for shadow */
        }
        /* ============================================== */
/* âœ… ADDED: SLOTS SPINNING ANIMATION */
/* ============================================== */

/* 1. á‹¨áˆ½áŠ­áˆ­áŠ­áˆ©áŠ• áŠ¥áŠ•á‰…áˆµá‰ƒáˆ´ á‹¨áˆšá‹ˆáˆµáŠ• á‰áˆá ááˆ¬áˆ */
@keyframes slot-spin {
    /* 1200px á‰áˆ˜á‰± á‹«áˆˆá‹ á‹¨á‹áŒ¤á‰¶á‰½ áˆ°áŠ•áˆ°áˆˆá‰µ (Strip) áŠ áˆˆ á‰¥áˆˆáŠ• áŠ¥áŠ•áŒˆáˆá‰³áˆˆáŠ• */
    to {
        transform: translateY(-1200px); /* áŠ¨áˆ‹á‹­ á‹ˆá‹° á‰³á‰½ á‰ ááŒ¥áŠá‰µ á‹­áˆ½áŠ¨áˆ¨áŠ¨áˆ«áˆ */
    }
}

/* 2. áˆ½áŠ­áˆ­áŠ­áˆ©áŠ• áˆˆáˆšáŒ€áˆáˆ­ áˆ›áŠ•áŠ›á‹áˆ Slot Reel */
.slot-reel.spinning {
    /* á‹¨áŠ áŠ’áˆœáˆ½áŠ‘ ááŒ¥áŠá‰µ áŠ¥áŠ“ áŠ á‹­áŠá‰µ */
    animation: slot-spin 0.1s steps(10) infinite; 
    /* ğŸ›‘ steps(10) áˆ›áˆˆá‰µ 10 á‹¨á‰°áˆˆá‹«á‹© áˆáˆµáˆá‰½ á‹«áˆ‰á‰µ Strip áŠ áˆˆ á‰¥áˆˆáŠ• áŒˆáˆá‰°áŠ“áˆ */
}

/* 3. áˆ½áŠ­áˆ­áŠ­áˆ© áˆ²á‰†áˆ á‹ˆá‹° á‰µáŠ­áŠ­áˆˆáŠ›á‹ á‰¦á‰³ áŠ¥áŠ•á‹²á‹«áˆ­á */
/* áˆ½áŠ­áˆ­áŠ­áˆ© áˆ²á‹«áˆá‰… á‹ˆá‹° á‰¦á‰³á‹ áŠ¥áŠ•á‹²áŠ•áˆ¸áˆ«á‰°á‰µ */
.slot-reel {
    transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); /* áˆ½áŠ­áˆ­áŠ­áˆ© áŠ¥áŠ•á‹²á‹«áˆáˆ­ á‹«á‹°áˆ­áŒˆá‹‹áˆ */
}


        .timer-container {
            background-color: #333333;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--tg-text);
        }
</style>
 <body>
<div id="loading-container">
        <img id="coin-image" class="coin-spinner" src="smart_airdrop_coin.png" alt="Coin Loading" />

        <p id="loading-text">SMART AIRDROP Loading...</p>
    </div>

    <div id="daily-reward-modal">
        <div class="reward-content">
            <button class="close-button" onclick="closeDailyRewardModal()">âœ•</button>
            <h2>Daily Reward</h2>
            <p>Get a daily bonus by logging into the game every day without skipping</p>

            <div id="reward-grid" class="reward-grid">
                </div>

            <button id="daily-reward-claim-button" disabled>Come back tomorrow</button>
        </div>
    </div>

    <div id="root">
        <div id="tasks-page" class="page" style="display: none; padding: 15px 0;">
            <h1 class="page-title">á‹•áˆˆá‰³á‹Š á‰°áŒá‰£áˆ«á‰µ</h1>

            <div class="score-card-display">
                áŒ á‰…áˆ‹áˆ‹ coin : <span id="tasks-score-display" style="color: var(--et-yellow);">0 ğŸ’°</span>
            </div>

      <div class="invite-card-container">
    <div class="invite-card">
        <div class="header-section">
            <div class="icon-circle">$</div>
            <div class="text-content">
                <p class="title">+500 Coin áˆµáŒ¦á‰³</p>
                <p class="subtitle"></p>
            </div>
        </div>
        <div class="button-row">
            <a href="#" class="invite-button primary-button" id="telegramInviteLink" onclick="window.handleInviteClick(null, 500, 'last_invite_time')">
    áŒ“á‹°áŠ› áŒ‹á‰¥á‹
</a>

           <button class="copy-button" title="á‰…á‹³" onclick="handleCopyInviteLink()">
    <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    </button>
     
          
          </div>
    </div>
</div>
  </button>
            <div class="daily-tasks-container">
                <button class="task-button" style="background-color: var(--et-yellow);" onclick="handleCardClick('scratch-card-page');">
                    SCRATCH ğŸ<span>áŠ¥áˆˆá‰³á‹Š coin </span>
                </button>
                <button class="task-button" style="background-color: var(--et-purple);" onclick="window.openDailyRewardModal();">
                    STREAK ğŸ”¥<span>á‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ</span>
                </button>
                <button class="task-button" style="background-color: var(--et-green);" onclick="window.handleTaskClick('Lucky Box', 200, 'last_luckybox_time');">
                    LUCKY BOX ğŸ“¦<span>+200 coin </span>
                </button>
            </div>

            <div class="card-buttons-section" style="display: block;">
                <h2 style="font-size: 18px; margin-bottom: 15px; color: var(--tg-text);">áˆá‹© áŒ¨á‹‹á‰³á‹á‰½ (Daily)</h2>

                <button class="card-button" id="mystery-box-card" onclick="handleCardClick('mystery-box-page')">
                    <div class="card-icon-circle" style="background-color: var(--et-red);">ğŸ</div>
                    <div class="card-text-container">
                        <div class="card-title">Mystery Box Game</div>
                        <div class="card-subtitle">áˆšáˆµáŒ¥áˆ«á‹Š áˆ£áŒ¥áŠ• áŠ­áˆá‰µ áŠ¥áŠ“ á‹¨á‹˜áˆá‰€á‹° coin áŠ áŒáŠá¢</div>
                    </div>
                    <div id="mystery-box-badge" class="status-badge">...</div>
                    <div class="arrow-icon">â†’</div>
                </button>

                <button class="card-button" id="daily-spin-card" onclick="handleCardClick('daily-spin-page')">
                    <div class="card-icon-circle" style="background-color: var(--et-blue);">ğŸ°</div>
                    <div class="card-text-container">
                        <div class="card-title">Daily Spin</div>
                        <div class="card-subtitle">á‹•áˆˆá‰³á‹Š áˆ½áŠ­áˆ­áŠ­áˆ­ (Spin) á‹«áˆ½áŠ¨áˆ­áŠ­áˆ©áŠ“ coin  á‹«áˆ¸áŠ•á‰á¢</div>
                    </div>
                    <div id="daily-spin-badge" class="status-badge">...</div>
                    <div class="arrow-icon">â†’</div>
                </button>

                <button class="card-button" id="reflex-game-card" onclick="handleCardClick('reflex-game-page')">
                    <div class="card-icon-circle" style="background-color: var(--et-green);">âš¡</div>
                    <div class="card-text-container">
                        <div class="card-title">Reflex Game</div>
                        <div class="card-subtitle">á‰ ááŒ¥áŠá‰µ áˆáˆ‹áˆ½ áˆ°áŒ¥á‰°á‹ coin á‹«áŒáŠ™á¢</div>
                    </div>
                    <div id="reflex-game-badge" class="status-badge">...</div>
                    <div class="arrow-icon">â†’</div>
                </button>

                <button class="card-button" id="social-tasks-card" onclick="handleCardClick('social-tasks-page')">
                    <div class="card-icon-circle" style="background-color: var(--et-purple);">ğŸŒ</div>
                    <div class="card-text-container">
                        <div class="card-title">Social Tasks</div>
                        <div class="card-subtitle">áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ«á‰µáŠ• á‹«áŒ áŠ“á‰…á‰ áŠ¥áŠ“ á‰µáˆá‰… coin á‹­á‹áˆ°á‹±!</div>
                    </div>
                    <div class="arrow-icon">â†’</div>
                </button>

                <button class="card-button" id="slots-game-card" onclick="handleCardClick('slots-game-page')">
                    <div class="card-icon-circle" style="background-color: var(--et-red);">ğŸ°</div>
                    <div class="card-text-container">
                        <div class="card-title">Lucky Slot Game</div>
                        <div class="card-subtitle">áŠ¥áˆˆá‰³á‹Š áŠ¥áˆ½áŠ­áˆ­áŠ­áˆªá‰µ áŠ áˆ¸áŠ•áˆá‹ coin á‹«áŒáŠ™!</div>
                    </div>
                    <div class="arrow-icon">â†’</div>
                </button>
                </div>
        </div>

        <div id="slots-game-page" class="game-page-container" style="display: none; text-align: center;">
            <h2 class="page-title">Lucky Slot Machine</h2>

            <div class="daily-game-card">
                <div class="header">
                    <span class="back-button" onclick="showMainPage()">â†</span>
                    <div class="main-title">á‹•á‹µáˆˆáŠ› </div>
                    <div class="sub-title">á‹•áˆˆá‰³á‹Š áŠ¥áˆ½áŠ­áˆ­áŠ­áˆªá‰µ</div>
                </div>

                <div class="info-bar">
                    <div class="info-item">
                         <span id="coin-wins">0</span>
                    </div>
                    <div class="info-item">
                        á‰€áˆª áˆ™áŠ¨áˆ«á‹á‰½ <span id="spins-left">10</span>
                    </div>
                </div>

                <div class="slots-area">
                    <div class="slot" id="slot-1"><div class="slot-content">?</div></div>
                    <div class="slot" id="slot-2"><div class="slot-content">?</div></div>
                    <div class="slot" id="slot-3"><div class="slot-content">?</div></div>
                </div>

                <button class="btn" id="claim-btn" disabled>Claim coin</button>

                <button class="btn" id="spin-btn">
                    áŠ¥áˆ½áŠ­áˆ­áŠ­áˆªá‰µ áˆˆáˆ˜áŒ€áˆ˜áˆ­ á‹­áŒ«áŠ‘ <br> SPIN
                </button>

                <div class="message" id="game-message"></div>

                <div class="timer-container" style="display: none;" id="reset-timer-container">
                     <br>
                     <span id="reset-timer"></span>
                </div>
            </div>

            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>
        <div id="top-page" class="page" style="display: none; padding: 15px 0;">
            <h1 class="page-title">TOPE USERS</h1>

            <div class="top-user-card" style="border: 2px solid var(--et-yellow);">
                <div style="font-size: 18px; font-weight: bold; color: var(--tg-text);">ğŸ‘¤ á‹¨áŠ¥áˆ­áˆµá‹ á‹°áˆ¨áŒƒ</div>
                <div class="top-user-stats">
                    <div class="stat-item" style="color: var(--et-yellow); background-color: #333333;">
                        <span id="top-score-display">0 ğŸ’°</span>
                        á‹¨áŠ¥áˆ­áˆµá‹ coin
                    </div>
                    <div class="stat-item" style="color: var(--et-blue); background-color: #333333;">
                        <span id="top-rank-display"> </span>
                        á‹¨áŠ¥áˆ­áˆµá‹ á‹°áˆ¨áŒƒ
                    </div>
                </div>
            </div>

            <h2 style="font-size: 20px; margin-bottom: 15px; color: var(--tg-text);">ğŸ¥‡ Top Users (Top 50)</h2>

            <div id="leaderboard-container">
                <p style="text-align: center; color: var(--tg-hint); padding: 10px;">áŠ¥á‰£áŠ­á‹áŠ• á‰µáŠ•áˆ½ á‹­áŒ á‰¥á‰á¢</p>
            </div>
        </div>

        <div id="profile-page" class="page" style="display: none; padding: 0 0;">

            <div class="profile-avatar" id="profile-avatar">ğŸ‘¤</div>
            <div class="profile-username-display" id="profile-username"></div>

            <div class="profile-stat-box" style="margin-bottom: 20px;">
                <div class="stat-label" style="font-size: 18px;">
                    <span class="icon">ğŸ’µ</span> Balance
                </div>
                <div>
                    <span class="balance-value">0 airdrop</span>
                    <button class="withdraw-button" onclick="switchPage('withdraw-page');">
                        Withdraw
                    </button>
                </div>
            </div>

            <div class="profile-stat-box">
                <div class="stat-label">
                    <span class="icon">â­</span> Coins
                </div>
                <span id="profile-score-display" style="font-weight: bold; color: var(--et-yellow);">0 ğŸ’°</span>
            </div>

            <div class="profile-stat-box">
                <div class="stat-label">
                    <span class="icon">ğŸ«</span> Tickets
                </div>
                <span id="profile-ticket-display" style="font-weight: bold; color: var(--tg-text);">0</span>
            </div>

            <div class="profile-stat-box">
                <div class="stat-label">
                    <span class="icon">ğŸ”„</span> Exchange
                </div>
                <button class="withdraw-button" onclick="switchPage('exchange-page');" style="background-color: var(--et-red);">
                    Exchange
                </button>
            </div>

            <h2 style="font-size: 18px; margin: 30px 0 15px 0; color: var(--tg-text); text-align: left;">Settings</h2>

            <button class="profile-action-button" onclick="handleWalletConnect()">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span class="stat-label">
                        <span class="icon">ğŸ’¼</span> Connect to Wallet
                    </span>
                    <span class="exchange-status">Connect ></span>
                </div>
            </button>

            <button class="profile-action-button" onclick="window.handleSupportClick()">
                <span class="stat-label">
                    <span class="icon">â“</span> Support
                </span>
            </button>

            <button class="profile-action-button" onclick="window.handleCloseClick()">
                <span class="stat-label">
                    <span class="icon">âœ–ï¸</span> á‹áŒ‹ (Close App)
                </span>
            </button>
     </div>
   <div id="social-tasks-page" class="game-page-container" style="display: none; text-align: left;">
            <h1 class="social-tasks-title">Social Tasks</h1>
            <p class="social-tasks-subtitle">áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ«á‰µáŠ• á‰ áˆ›áŒ áŠ“á‰€á‰… á‰°áŒ¨áˆ›áˆª coin á‹«áŒáŠ™!</p>

            <div class="social-task-card" id="task-channel">
                <div class="social-task-icon-container" style="background-color: var(--et-blue);">
                    <span style="color: white;">âœˆï¸</span>
                </div>
                <div class="social-task-text-container">
                    <div class="social-task-title">Telegram Channel</div>
                    <div class="social-task-reward">+1500 ğŸ’°</div>
                </div>
                <button
                    class="social-task-action-button join-style"
                    id="channel-action"
                    data-link="https://t.me/Smart_Airdropss"
                    data-points="1500"
                    data-field="last_social_tg_channel_time"
                    data-name="Telegram Channel Join"
                    onclick="window.handleSocialTaskClick(this, 'join')">
                    Join
                </button>
            </div>

            <div class="social-task-card" id="task-group">
                <div class="social-task-icon-container" style="background-color: var(--et-blue);">
                    <span style="color: white;">ğŸ‘¥</span>
                </div>
                <div class="social-task-text-container">
                    <div class="social-task-title">Telegram Group</div>
                    <div class="social-task-reward">+1000 ğŸ’°</div>
                </div>
                <button
                    class="social-task-action-button join-style"
                    id="group-action"
                    data-link="https://t.me/school_library2012"
                    data-points="1000"
                    data-field="last_social_tg_group_time"
                    data-name="Telegram Group Join"
                    onclick="window.handleSocialTaskClick(this, 'join')">
                    Join
                </button>
            </div>

            <div class="social-task-card" id="task-youtube">
                <div class="social-task-icon-container" style="background-color: var(--et-red);">
                    <span style="color: white;">â–¶ï¸</span>
                </div>
                <div class="social-task-text-container">
                    <div class="social-task-title">YouTube Subscribe</div>
                    <div class="social-task-reward">+3000 ğŸ’°</div>
                </div>
                <button
                    class="social-task-action-button join-style"
                    id="youtube-action"
                    data-link="https://www.youtube.com/"
                    data-points="3000"
                    data-field="last_social_youtube_time"
                    data-name="YouTube Subscribe"
                    onclick="window.handleSocialTaskClick(this, 'subscribe')">
                    Subscribe
                </button>
            </div>


            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>
        <div id="mystery-box-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Mystery Box Game</h2>
            <div class="game-info-box">
                <p>á‹•áˆˆá‰³á‹Šá‹áŠ• áˆšáˆµáŒ¥áˆ«á‹Š áˆ£áŒ¥áŠ• á‹­áŠ­áˆá‰± áŠ¥áŠ“ á‰µáˆá‰… coin á‹«áˆ¸áŠ•á‰!</p>
                <div id="mystery-box-timer" class="cooldown-timer">Ready!</div>
                <p style="font-size: 12px; color: var(--tg-hint); margin-top: 10px;">áˆ½áˆáˆ›á‰µ: +100 - +500 coin (á‰ á‹¨ 24 áˆ°á‹“á‰±)</p>
            </div>

            <div id="box-container" class="box-container">
                <div class="mystery-box" id="box-1" onclick="playMysteryBox(1)">?</div>
                <div class="mystery-box" id="box-2" onclick="playMysteryBox(2)">?</div>
                <div class="mystery-box" id="box-3" onclick="playMysteryBox(3)">?</div>
            </div>
            <p id="box-message" style="font-size: 16px; margin-top: 20px; font-weight: bold; color: var(--et-yellow);"></p>

            <button id="mystery-box-action" class="game-action-button" onclick="resetMysteryBox()">áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©</button>

            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>

        <div id="daily-spin-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Daily Spin</h2>
            <div class="game-info-box">
                <p>á‹•á‹µáˆˆáŠ› áˆ½áŠ­áˆ­áŠ­áˆ­ (Spin) á‹«áˆ½áŠ¨áˆ­áŠ­áˆ© áŠ¥áŠ“ coin á‹«áŒáŠ™!</p>
                <div id="daily-spin-timer" class="cooldown-timer">Ready!</div>
            </div>

            <div class="wheel-container">
                <div class="pointer"></div>
                <div class="wheel" id="spin-wheel">
                    <div class="segment" style="background-color: #F44336; transform: rotate(0deg);">
                        <div class="segment-content">
                            <span class="segment-text">1000 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #FFEB3B; transform: rotate(36deg);">
                        <div class="segment-content">
                            <span class="segment-text">500 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #9C27B0; transform: rotate(72deg);">
                        <div class="segment-content">
                            <span class="segment-text">200 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #2196F3; transform: rotate(108deg);">
                        <div class="segment-content">
                            <span class="segment-text">100 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #00BCD4; transform: rotate(144deg);">
                        <div class="segment-content">
                            <span class="segment-text">50 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #4CAF50; transform: rotate(180deg);">
                        <div class="segment-content">
                            <span class="segment-text">20 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #8BC34A; transform: rotate(216deg);">
                        <div class="segment-content">
                            <span class="segment-text">10 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #CDDC39; transform: rotate(252deg);">
                        <div class="segment-content">
                            <span class="segment-text">5 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #FF9800; transform: rotate(288deg);">
                        <div class="segment-content">
                            <span class="segment-text">0 coin</span>
                        </div>
                    </div>
                    <div class="segment" style="background-color: #FF5722; transform: rotate(324deg);">
                        <div class="segment-content">
                            <span class="segment-text">10 coin</span>
                        </div>
                    </div>
                    <div style="position: absolute; width: 50px; height: 50px; background-color: var(--tg-bg); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid var(--et-yellow); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px;">0</div>
                </div>
            </div>

            <button id="daily-spin-action" class="game-action-button" onclick="spinTheWheel()">áŠ áˆ½áŠ¨áˆ­áŠ­áˆ­</button>

            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>

        <div id="reflex-game-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Reflex Game</h2>
            <div class="game-info-box">
                <p>áˆáŒ£áŠ•áŠá‰µá‹áŠ• á‹­áˆá‰µáŠ‘! á‰ ááŒ¥áŠá‰µ áˆáˆ‹áˆ½ áˆ°áŒ¥á‰°á‹ coin á‹«áŒáŠ™á¢</p>
                <div id="reflex-game-timer" class="cooldown-timer">Ready!</div>
                <p style="font-size: 12px; color: var(--tg-hint); margin-top: 10px;">áˆ½áˆáˆ›á‰µ: áŠ¨ááŒ¥áŠá‰µá‹ áŒ‹áˆ­ á‰°áˆ˜áŒ£áŒ£áŠ (á‰ á‹¨ 24 áˆ°á‹“á‰±)</p>
            </div>

            <div id="reflex-play-area">
                <div id="reflex-button" onclick="stopReflexGame(event)">TAP ME!</div>
                <p id="reflex-message">áˆˆáˆ˜áŒ€áˆ˜áˆ­ áŠ¨á‰³á‰½ á‹«áˆˆá‹áŠ• á‰áˆá á‹­áŒ«áŠ‘á¢</p>
            </div>
            <p id="reflex-result" style="font-size: 18px; font-weight: bold; color: var(--et-yellow);"></p>

            <button id="reflex-game-action" class="game-action-button" onclick="startReflexGame()">áŒ¨á‹‹á‰³á‹áŠ• áŒ€áˆáˆ­</button>

            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>

        <div id="scratch-card-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Scratch Card Game ğŸ</h2>
            <div class="game-info-box">
                <p>áŠ«áˆ­á‹±áŠ• á‰ áˆ˜áˆá‰…áˆá‰… (Scratch) á‹¨á‰°á‹°á‰ á‰€á‹áŠ• áˆ½áˆáˆ›á‰µ á‹«áŒáŠ™!</p>
                <div id="scratch-card-timer" class="cooldown-timer">Loading...</div>
                <p style="font-size: 12px; color: var(--tg-hint); margin-top: 10px;">áˆ½áˆáˆ›á‰µ: áŠ¨ +100 áŠ¥áˆµáŠ¨ +500 coin (á‰ á‹¨ 12 áˆ°á‹“á‰±)</p>
            </div>

            <div id="scratch-card-container">
                <div id="scratch-prize-text" class="scratch-prize-layer">
                    <span>+500 ğŸ’°</span>
                </div>
                <canvas id="scratch-canvas" class="scratch-top-layer"></canvas>
            </div>

            <p id="scratch-result-message" style="font-size: 16px; margin-top: 20px; font-weight: bold; color: var(--et-yellow); min-height: 20px;"></p>

            <button id="scratch-card-action" class="game-action-button" style="display: none;" onclick="window.initScratchCard(true);">
                áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©
            </button>

            <button class="game-back-button" onclick="showMainPage()">â† á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ</button>
        </div>
        <div id="withdraw-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Coin áˆ›á‹áŒ« (Withdraw)</h2>
            <div class="game-info-box">
                <p>áŠ¥á‹šáˆ… á‹¨á‰°áˆ°á‰ áˆ°á‰ á‹áŠ• coin á‹áŠ• á‹ˆá‹° á‰°áˆ˜áŒ£áŒ£áŠ á‰¶áŠ¨áŠ•/áŒˆáŠ•á‹˜á‰¥ áˆáŠ•á‹›áˆª áˆ˜áˆˆá‹ˆáŒ¥ á‹­á‰½áˆ‹áˆ‰á¢</p>
                <p style="margin-top: 10px; font-weight: bold;">(á‹­áˆ… á‰°áŒá‰£áˆ­ á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹­áˆ˜áŒ£áˆá¢)</p>
            </div>
            <button class="game-back-button" onclick="switchPage('profile-page')">â† á‹ˆá‹° Profile á‰°áˆ˜áˆˆáˆµ</button>
        </div>

        <div id="exchange-page" class="game-page-container" style="display: none;">
            <h2 class="page-title">Coin áˆ˜á‰€á‹¨áˆªá‹« (Exchange)</h2>

            <div class="game-info-box">
                <p style="font-size: 14px; color: var(--tg-hint);">
                    á‹¨áˆá‹á‹áŒ¥ áŒ¥á‹«á‰„á‹áŠ• áŠ¥á‹šáˆ… á‹«áˆµáŒˆá‰¡á¢ áŒ¥á‹«á‰„á‹ á‰ áŠ áˆµá‰°á‹³á‹³áˆªá‹á‰½ á‹­áŒ£áˆ«áˆá£ áŠ¨á‹šá‹«áˆ coiná‹ á‰°á‰€áŠ•áˆ¶ áŒˆáŠ•á‹˜á‰¥ á‹­áŒ¨áˆ˜áˆ­áˆá‹á‰³áˆá¢
                </p>
                <p style="text-align: center; font-weight: bold; color: var(--et-yellow); margin-top: 15px;">
                    áˆá‹á‹áŒ¥ áˆáŒ£áŠ”: 10,000 coin=...
                </p>
            </div>

            <div style="background-color: #333333; padding: 20px; border-radius: 10px;">
                <label for="exchangePointsInput" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px;">
                    áˆ˜á‰€á‹¨áˆ­ á‹¨áˆšáˆáˆáŒ‰á‰µáŠ• coin á‹«áˆµáŒˆá‰¡ (á‰ 10,000 á‰¥á‹œá‰µ):
                </label>
                <input type="number" id="exchangePointsInput" placeholder="á‹á‰…á‰°áŠ›á‹: 10000" min="10000" step="10000" style="width: 95%; padding: 10px; margin-bottom: 20px; border: 1px solid #444; border-radius: 5px; background-color:var(--tg-secondary-bg); color: var(--tg-text);">

                <button id="finalChangeButton" disabled style="width: 100%; padding: 15px; font-size: 16px; font-weight: bold; color: white; background-color: #a0a0a0; border: none; border-radius: 8px; cursor: not-allowed; transition: background-color 0.3s;">
                    CHANGE
                </button>

                <p id="exchangeMessage" style="text-align: center; margin-top: 15px; font-weight: bold; font-size: 14px;"></p>
            </div>

            <button class="game-back-button" onclick="switchPage('profile-page')">â† á‹ˆá‹° Profile á‰°áˆ˜áˆˆáˆµ</button>
        </div>
        </div>

    <div id="nav-bar">
        <div class="nav-item active" id="nav-tasks" onclick="switchPage('tasks-page')">
            <span class="nav-icon">â­</span>
            <span>Tasks</span>
        </div>
        <div class="nav-item" id="nav-top" onclick="switchPage('top-page')">
            <span class="nav-icon">ğŸ‘‘</span>
            <span>Top</span>
        </div>
        <div class="nav-item" id="nav-profile" onclick="switchPage('profile-page')">
            <span class="nav-icon">ğŸ‘¤</span>
            <span>Profile</span>
        </div>
    </div>
 <script>
        // ğŸ›‘ áˆ˜áá‰µáˆ” 2: á‹¨ showMainPage() á‰°áŒá‰£áˆ­ á‹ˆá‹° áŒáˆá‰£áˆ áˆµáŠ®á• á‰°áˆ˜áˆˆáˆ°
        window.showMainPage = () => switchPage('tasks-page'); 
        
        // ======================================================================
        // ğŸ›‘ NEW: á‹¨á‹ˆáˆ¨á‰€á‰µ áŠ®áŠ•áŒá‰² áŠ áŠ’áˆœáˆ½áŠ• á‰°áŒá‰£áˆ­ (Paper Confetti)
        // ======================================================================
        window.triggerConfetti = (points) => {
            if (typeof confetti === 'undefined') return;

            // áˆˆ200 coin áŠ¥áŠ“ áŠ¨á‹šá‹« á‰ áˆ‹á‹­ á‰¥á‰» áŠ¥áŠ•á‹²áˆ°áˆ«
            if (points < 200) return; 

            // á‹¨coin áˆ˜áŒ áŠ• áˆ²áŒ¨áˆáˆ­ á‹¨áŠ®áŠ•áŒá‰²á‹áŠ• áˆ˜áŒ áŠ• áŠ¥áŠ“ áˆµáˆ­áŒ­á‰µ á‹­áŒ¨áˆáˆ«áˆ
            const particleCount = points >= 500 ? 180 : 100;
            const spread = points >= 500 ? 90 : 70;
            
            // áˆˆá‹ˆáˆ¨á‰€á‰µ áŠ®áŠ•áŒá‰² á‹¨áˆšáˆ†áŠ‘ á‹°áˆ›á‰… á‰€áˆˆáˆá‰½
            const colors = ['#FFD700', '#1E90FF', '#FF69B4', '#32CD32', '#C0C0C0']; 

            // á‹¨á‹‹áŠ“ áŠ®áŠ•áŒá‰² ááŠ•á‹³á‰³
            confetti({
                particleCount: particleCount,
                spread: spread,
                origin: { y: 0.5 }, 
                colors: colors,
                // ğŸ›‘ á‹¨á‹ˆáˆ¨á‰€á‰µ áŒˆáŒ½á‰³: áŠ áˆ«á‰µ áˆ›á‹•á‹˜áŠ• áŠ¥áŠ“ á‰µáŠ•áˆ½ áŠ áˆ«á‰µ áˆ›á‹•á‹˜áŠ• á‰…áˆ­áŒ¾á‰½
                shapes: ['square', 'rect'], 
                scalar: 1.1, // á‹¨á‰…áŠ•áŒ£á‰¶á‰¹áŠ• áˆ˜áŒ áŠ• á‰µáŠ•áˆ½ áˆ˜áŒ¨áˆ˜áˆ­
                zIndex: 9998
            });
            
            // áˆˆá‰°áŒ¨áˆ›áˆª á‹µáˆ«áˆ›á‹ŠáŠá‰µ áˆ¨á‹£á‹¥áˆ á‹ˆáˆ¨á‰€á‰¶á‰½ (Ribbons)
            if (points >= 500) {
                function fireFromSide(angle, originX) {
                    confetti({
                        particleCount: 20,
                        angle: angle,
                        spread: 30,
                        origin: { x: originX, y: 0.9 }, 
                        colors: ['#FFC107', '#FFFFFF'], // á‹ˆáˆ­á‰… áŠ¥áŠ“ áŠáŒ­
                        // ğŸ›‘ á‹¨á‹ˆáˆ¨á‰€á‰µ áŒˆáŒ½á‰³: áˆ¨á‹£á‹¥áˆ á‹¨á‹ˆáˆ¨á‰€á‰µ áŠ­áˆ®á‰½ (ribbons)
                        shapes: ['line'], 
                        scalar: 0.6,
                        startVelocity: 30,
                        decay: 0.9,
                        zIndex: 9998
                    });
                }
                fireFromSide(45, 0); // áŠ¨áŒáˆ«
                fireFromSide(135, 1); // áŠ¨á‰€áŠ
            }
        }
        
   // ======================================================================
// âœ… á‹¨á‹µáˆáŒ½ áˆ›áŒ«á‹ˆá‰» á‰°áŒá‰£áˆ­ ( window. á‰°á‹ˆáŒá‹·áˆ - á‰µáŠ­áŠ­áˆˆáŠ› áŠ¥áŠ“ áŠ•áŒ¹áˆ… áˆµáˆªá‰µ)
// ======================================================================

const BASE_URL = 'https://tame3232.github.io/2/Sound/'; 

const soundUrls = {
    spin: BASE_URL + 'spin_sound.mp3',   
    win: BASE_URL + 'win_sound.mp3',     
    fail: BASE_URL + 'fail_sound.mp3',
    click: BASE_URL + 'click_sound.mp3'
};

const loadedSounds = {};
for (const type in soundUrls) {
    if (soundUrls.hasOwnProperty(type)) {
        loadedSounds[type] = new Audio(soundUrls[type]);
        // ğŸ›‘ FIX 5: .load() á‰°á‹ˆáŒá‹·áˆá¢
        // áŠ áˆ³áˆ¹ áˆ«áˆ± play() áˆ²á‰£áˆ áˆ˜áŒ«áŠ• á‹­áŒ€áˆáˆ«áˆ (á‹­áˆ… á‹¨á‰°áˆ»áˆˆ áŠá‹)
        // loadedSounds[type].load(); 
    }
}

// áŠ áˆáŠ• á‰°áŒá‰£áˆ© 'playSound' á‰¥á‰» á‰°á‰¥áˆáˆ
window.playSound = (type) => {
    const audio = loadedSounds[type];
    
    if (audio) {
        audio.pause();
        audio.currentTime = 0; 
        
        audio.play().catch(e => {
            console.warn(`Sound playback failed for '${type}':`, e.message);
        });
    } else {
        console.warn(`á‹¨áˆ›á‹­á‰³á‹ˆá‰… á‹¨á‹µáˆá… áŠ á‹­áŠá‰µ á‰°áŒ á‹­á‰‹áˆ: ${type}`);
    }
}

    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, updateDoc, doc, setDoc, collection, query, onSnapshot, orderBy, limit, increment, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // ===================================================================================
        // === 2. á‹¨áŠ¥áˆ­áˆµá‹ Firebase Configuration ===
        // ===================================================================================
        const firebaseConfig = {
          // ğŸ›‘ áˆ›áˆµá‰³á‹ˆáˆ»: áŠ¥áŠá‹šáˆ… á‰áˆáá‰½ á‰ á‰µáŠ­áŠ­áˆ áŠ¨áŠ¥áˆ­áˆµá‹ Firebase project áŒ‹áˆ­ áˆ˜á‹›áˆ˜á‹µ áŠ áˆˆá‰£á‰¸á‹
          apiKey: "AIzaSyA9rGEGZifwxz820MR-DZZ6BGHTTZfd7Y4",
          authDomain: "mysteryspingame-41d3b.firebaseapp.com",
          projectId: "mysteryspingame-41d3b",
          storageBucket: "mysteryspingame-41d3b.appspot.com", 
          messagingSenderId: "1078389216479",
          appId: "1:1078389216479:web:75c64f5e4ff147c10f856a"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 


        const WebApp = window.Telegram.WebApp;
        let currentFirebaseUserId = null; 
        let telegramUserId = null; 
        let currentScore = 0; // 
        let currentTickets = 0; 
        let currentUserDocData = null; 
        let currentRank = 'N/A'; 
        let isReflexGameRunning = false; 
        let timerIntervals = {}; // áˆˆáˆáˆ‰áˆ Cooldown Timers á‹¨áˆšá‹áˆ
        
        // ğŸ›‘ NEW: áˆˆá‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ (Daily Streak) á‹¨áˆšá‹«áŒˆáˆˆáŒáˆ á‹áˆ­á‹áˆ­
        const dailyStreakRewards = [
            { day: 1, coins: 700, field: 'day_1_claimed' }, // 
            { day: 2, coins: 1500, field: 'day_2_claimed' },
            { day: 3, coins: 3000, field: 'day_3_claimed' },
            { day: 4, coins: 7000, field: 'day_4_claimed' },
            { day: 5, coins: 15000, field: 'day_5_claimed' },
            { day: 6, coins: 30000, field: 'day_6_claimed' },
            { day: 7, coins: 100000, field: 'day_7_claimed' },
            { day: 8, coins: 500000, field: 'day_8_claimed' },
            { day: 9, coins: 1000000, field: 'day_9_claimed' },
            { day: 10, coins: 2000000, field: 'day_10_claimed' },
        ];
        
        // ======================================================================
        // ğŸ›‘ UPDATED: áˆˆ Slot Game á‹¨áˆšá‹«áˆµáˆáˆáŒ‰ áˆ˜áˆ¨áŒƒá‹á‰½
        // ======================================================================
        const SLOTS_MAX_SPINS = 10;
        const SLOTS_COOLDOWN_FIELD = 'last_slot_reset_time';
        // ğŸ›‘ TICKET_REWARD á‹ˆá‹° COIN_REWARD á‰°á‰€á‹­áˆ¯áˆ áŠ¥áŠ“ á‹ˆá‹²á‹«á‹áŠ‘ á‹ˆá‹° coin á‹­á‹°áˆ˜áˆ«áˆ
        const COIN_REWARD = 1000; 
        let currentSpinsLeft = SLOTS_MAX_SPINS;
        // ğŸ›‘ slot_teto_wins á‰°á‹ˆáŒá‹·áˆ
        const slotItems = [
            'ğŸ’', // Diamond (á‰µáˆá‰… áŠ áˆ¸áŠ“áŠ)
            'â­', // Star
            'ğŸ’°', // Money Bag
            'ğŸ’', // Cherry
        ];


        // ======================================================================
        //                             UTILITY FUNCTIONS
        // ======================================================================
        
        function getAvatarHtml(username, photoUrl) {
            if (photoUrl) {
                return `<img src="${photoUrl}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                const initial = username ? username.charAt(0).toUpperCase() : 'ğŸ‘¤';
                return initial;
            }
        }
        
        // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆ: á‹¨ Streak áŠ¥áŠ“ Slot áŠ áˆ˜áŠ­áŠ•á‹® á‰ áˆá‹© áˆáŠ”á‰³ á‰°á‹­á‹Ÿáˆ
        function checkDailyLimit(taskField) {
            if (!currentUserDocData || !currentUserDocData[taskField]) {
                // áˆˆáˆ˜áŒ€áˆ˜áˆªá‹« áŒŠá‹œ áˆ²áŒ áˆ« (á‹ˆá‹­áŠ•áˆ á‹³á‰³ á‹¨áˆŒáˆˆá‹ áŠ¨áˆ†áŠ)
                return { isReady: true, remainingMs: 0, hasCompleted: false };
            }

            const lastUsedTimestamp = currentUserDocData[taskField];
            let lastUsedDate;

            if (lastUsedTimestamp && lastUsedTimestamp.toDate) {
                lastUsedDate = lastUsedTimestamp.toDate();
            } else {
                // áŒŠá‹œ áˆ›áˆ…á‰°áˆ™ á‰µáŠ­áŠ­áˆ áŠ«áˆáˆ†áŠ á‹ˆá‹­áˆ null áŠ¨áˆ†áŠ, á‹áŒáŒ áŠá‹
                return { isReady: true, remainingMs: 0, hasCompleted: false };
            }

            // áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ«á‰µ áŠ áŠ•á‹µ áŒŠá‹œ á‰¥á‰» á‹¨áˆšáˆ°áˆ© áŠ“á‰¸á‹ (á‹•áˆˆá‰³á‹Š áŒˆá‹°á‰¥ á‹¨áˆ‹á‰¸á‹áˆ)
            if (taskField.startsWith('last_social_')) {
                 // á‹¨"social" á‰°áŒá‰£áˆ«á‰µ áŠ áŠ•á‹´ áŠ¨á‰°áˆ°áˆ© á‰ áŠ‹áˆ‹ áˆáˆáŒŠá‹œ "hasCompleted" á‹­áˆ†áŠ“áˆ‰
                 return { isReady: false, remainingMs: 0, hasCompleted: true };
            }
            
            // áˆˆáˆáˆ‰áˆ á‹•áˆˆá‰³á‹Š áŒˆá‹°á‰¦á‰½ (24-áˆ°á‹“á‰µ)
            const now = new Date();
            const twentyFourHours = 12 * 60 * 60 * 1000; // ğŸ›‘ 12 áˆ°á‹“á‰µ áŠá‹ (24 áˆ˜áˆ†áŠ• á‹¨áˆˆá‰ á‰µáˆ?) - áŠ¥áŠ•á‹° áŠ®á‹µá‹ 12 áˆ°á‹“á‰µ áˆ†áŠ—áˆ
            const elapsed = now.getTime() - lastUsedDate.getTime();
            
            if (elapsed >= twentyFourHours) {
                return { isReady: true, remainingMs: 0, hasCompleted: false };
            } else {
                const remainingMs = twentyFourHours - elapsed;
                return { isReady: false, remainingMs: remainingMs, hasCompleted: false };
            }
        }
        
        function formatTime(ms) {
            if (ms <= 0) return "Ready!";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹ á‰°áŒá‰£áˆ­: á‹¨áŠ«áˆ­á‹µ á‰£áŒáŠ• áˆáŠ”á‰³ áˆ›á‹˜áˆ˜áŠ• áŠ¥áŠ“ á‹¨ pointer-events áˆ˜á‰†áŒ£áŒ áˆ­
        function updateTaskCardStatus(cardId, badgeId, cooldownField) {
            const card = document.getElementById(cardId);
            const badge = document.getElementById(badgeId);
            
            if (!card || !badge) return;

            // ğŸ›‘ UPDATED: áˆˆ Slot Card áˆá‹© áŠ áˆ˜áŠ­áŠ•á‹® áˆ˜áŒ¨áˆ˜áˆ­
            if (cardId === 'slots-game-card') {
                 const { isReady: resetReady, remainingMs: resetRemainingMs } = checkDailyLimit(cooldownField);
                 
                 if (currentSpinsLeft > 0) {
                     badge.innerText = `Spins: ${currentSpinsLeft}`;
                     badge.classList.remove('cooldown');
                     badge.classList.add('ready');
                     card.classList.remove('cooldown-style');
                     card.style.pointerEvents = 'auto'; 
                 } else if (!resetReady) {
                     // á‰†áŒ£áˆªá‹ áŠ«áˆˆá‰€ áŠ¥áŠ“ 24 áˆ°á‹“á‰µ áŠ«áˆ‹áˆˆáˆ (áˆ°á‹“á‰±áŠ• áŠ áˆ³á‹­)
                     badge.innerText = formatTime(resetRemainingMs); // ğŸ›‘ áˆ°á‹“á‰µ áŠ¥áŠ•á‹²á‹«áˆ³á‹­ á‰°á‹°áˆ­áŒ“áˆ
                     badge.classList.remove('ready');
                     badge.classList.add('cooldown');
                     card.classList.add('cooldown-style');
                     card.style.pointerEvents = 'none'; 
                 } else {
                      // á‰†áŒ£áˆªá‹ áŠ«áˆˆá‰€ áŠ¥áŠ“ 24 áˆ°á‹“á‰µ áŠ«áˆˆáˆ
                     badge.innerText = 'Ready to Reset!';
                     badge.classList.remove('cooldown');
                     badge.classList.add('ready');
                     card.classList.remove('cooldown-style');
                     card.style.pointerEvents = 'auto'; 
                 }
                 return; // áŠ¨ Slot Logic á‰ áŠ‹áˆ‹ áˆ˜á‹áŒ£á‰µ
            }
            
            const { isReady, remainingMs } = checkDailyLimit(cooldownField);

            if (isReady) {
                badge.innerText = 'Ready!';
                badge.classList.remove('cooldown');
                badge.classList.add('ready');
                card.classList.remove('cooldown-style'); 
                // ğŸ›‘ NEW: á‹áŒáŒ áŠ¨áˆ†áŠ áˆ˜áŒ«áŠ• áŠ¥áŠ•á‹²á‰½áˆ
                card.style.pointerEvents = 'auto'; 
            } else {
                // ğŸ›‘ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: áˆáˆáŒŠá‹œ áˆ™áˆ‰á‹áŠ• áŒŠá‹œ áŠ¥áŠ•á‹²á‹«áˆ³á‹­
                const displayTime = formatTime(remainingMs); 

                badge.innerText = displayTime;
                badge.classList.remove('ready');
                badge.classList.add('cooldown');
                card.classList.add('cooldown-style');
                // ğŸ›‘ NEW: á‹áŒáŒ áŠ«áˆáˆ†áŠ áˆ˜áŒ«áŠ• áŠ¥áŠ•á‹³á‹­á‰½áˆ
                card.style.pointerEvents = 'none'; 
            }
        }

        // ğŸ›‘ áŠ á‹²áˆµ á‰°áŒá‰£áˆ­: á‹¨áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ­áŠ• áˆáŠ”á‰³ áˆ›á‹˜áˆ˜áŠ•
        function updateSocialTaskStatus(taskElementId, link, coins, field, actionType) { 
            const button = document.getElementById(taskElementId);
            const { hasCompleted } = checkDailyLimit(field);
            
            if (!button) return;

            if (hasCompleted) {
                button.innerText = `Completed âœ…`;
                button.classList.remove('join-style');
                button.classList.add('completed-style');
                button.onclick = null;
                button.disabled = true;
            } else {
                 // áŠ á‹áˆ«áˆ©áŠ• á‹ˆá‹° áˆ˜áŒ€áˆ˜áˆªá‹« áˆáŠ”á‰³á‹ áˆ˜áˆ˜áˆˆáˆµ
                const actionText = actionType === 'subscribe' ? 'Subscribe' : 'Join';
                button.innerHTML = actionText; // áŒ½áˆá‰áŠ• áˆ›áˆµá‰°áŠ«áŠ¨áˆ
                button.classList.remove('completed-style');
                button.classList.add('join-style');
                button.disabled = false;
                button.onclick = () => window.handleSocialTaskClick(button, actionType);
            }
        }


        function startCooldownTimer(taskField, timerElementId, actionButtonId) {
            if (timerIntervals[taskField]) {
                clearInterval(timerIntervals[taskField]);
            }

            const timerEl = document.getElementById(timerElementId);
            const actionButton = document.getElementById(actionButtonId);
            
            if (!timerEl && !actionButton) return; 
            
            // ğŸ›‘ UPDATED: áˆˆ Slot Game Timer áˆá‹© áŠ áˆ˜áŠ­áŠ•á‹®
             if (taskField === SLOTS_COOLDOWN_FIELD) {
                 const { isReady, remainingMs } = checkDailyLimit(taskField);
                 const timerContainer = document.getElementById('reset-timer-container');
                 const spinBtn = document.getElementById('spin-btn');
                 const messageEl = document.getElementById('game-message');

                 if (isReady) {
                      if(currentSpinsLeft <= 0) {
                          // á‹³áŒáˆ á‹¨áˆ›áˆµáŒ€áˆ˜áˆ­ áŒŠá‹œ á‹°áˆ­áˆ·áˆ (áŒáŠ• áŒˆáŠ“ á‹³áŒáˆ áŠ áˆá‰°áŒ€áˆ˜áˆ¨áˆ)
                          if(timerContainer) timerContainer.style.display = 'block';
                          if(timerEl) timerEl.innerText = "Ready to Reset! Click SPIN to get 10 more.";
                          if (spinBtn) {
                              spinBtn.disabled = false;
                              spinBtn.innerText = "RESET & SPIN";
                              spinBtn.onclick = () => window.resetSlotGameAndSpin(true); // á‹³áŒáˆ áŠ áˆµáŒ€áˆáˆ­áŠ“ áˆµá’áŠ• áŠ á‹µáˆ­áŒ
                          }
                      } else {
                           if (timerContainer) timerContainer.style.display = 'none';
                      }
                      
                      // á‹­áˆ…áŠ•áŠ• á‹¨24-áˆ°á‹“á‰µ á‰†áŒ£áˆª á‰ á‹¨áˆ°áŠ¨áŠ•á‹± áˆ›áˆ„á‹µ áŠ á‹«áˆµáˆáˆáŒáˆ - á‰ áˆšáˆ½áŠ¨áˆ¨áŠ¨áˆ­á‰ á‰µ áŒŠá‹œ á‰¥á‰» áŠá‹ á‹¨áˆšá‹«áˆµáˆáˆáŒˆá‹
                      if (timerIntervals[taskField]) {
                           clearInterval(timerIntervals[taskField]);
                           delete timerIntervals[taskField];
                      }
                      return; 
                 } else if (currentSpinsLeft <= 0) {
                      // áŒˆá‹°á‰¡ áŠ áˆˆá‰€ áŠ¥áŠ“ áŒŠá‹œá‹ áŒˆáŠ“ áŠ áˆá‹°áˆ¨áˆ°áˆ
                      if (timerContainer) timerContainer.style.display = 'block';
                      if (spinBtn) spinBtn.disabled = true;
                      if (messageEl) messageEl.innerText = "Spin áŠ áˆá‰‹áˆá¢ áŒŠá‹œ áŠ¥áˆµáŠªáŒ áŠ“á‰€á‰… á‹­áŒ á‰¥á‰á¢";
                      
                      const updateSlotTimer = () => {
                           const { isReady: checkAgain, remainingMs: remainingAgain } = checkDailyLimit(taskField);
                           if(checkAgain) {
                               window.startCooldownTimer(taskField, timerElementId, actionButtonId); // áˆ«áˆ±áŠ• á‹³áŒáˆ áŒ áˆ­á‰¶ á‹áŒáŒ á‹«á‹°áˆ­áŒ‹áˆ
                           } else if (timerEl) {
                               timerEl.innerText = `Reset in: ${formatTime(remainingAgain)}`;
                           }
                      };
                      updateSlotTimer(); 
                      timerIntervals[taskField] = setInterval(updateSlotTimer, 1000);
                      return; // áŠ¨ Slot Logic á‰ áŠ‹áˆ‹ áˆ˜á‹áŒ£á‰µ
                 } else {
                      // áŠ¥á‹¨á‰°áŒ«á‹ˆá‰° áŠ¨áˆ†áŠ
                      if (timerContainer) timerContainer.style.display = 'none';
                      // Slot Game á‹¨áˆ«áˆ± á‹¨áˆ†áŠ áŒŠá‹œ á‰†áŒ£áˆª áŠ á‹«áˆµáˆáˆáŒˆá‹áˆ
                      return;
                 }
             }
             
             // ğŸ›‘ áˆˆáˆáˆ‰áˆ áˆŒáˆá‰½ áŒ¨á‹‹á‰³á‹á‰½
             const updateTimer = () => {
                 const { isReady, remainingMs } = checkDailyLimit(taskField);
                 
                 if (isReady) {
                     if (timerEl) timerEl.innerText = "Ready to Play!";
                     if(actionButton) {
                         actionButton.classList.remove('cooldown');
                         actionButton.disabled = false;
                     }
                     if (taskField === 'last_invite_time') { 
                         const inviteButton = document.getElementById('invite-button');
                         if(inviteButton) inviteButton.classList.remove('cooldown');
                         if(inviteButton) inviteButton.disabled = false;
                     }
                     if (timerIntervals[taskField]) {
                         clearInterval(timerIntervals[taskField]);
                         delete timerIntervals[taskField];
                     }

                 } else {
                     if (timerEl) timerEl.innerText = `Remaining Cooldown: ${formatTime(remainingMs)}`;
                     
                     if(actionButton) {
                         actionButton.classList.add('cooldown');
                         actionButton.disabled = true;
                     }
                     if (taskField === 'last_invite_time') { 
                         const inviteButton = document.getElementById('invite-button');
                         if(inviteButton) inviteButton.classList.add('cooldown');
                         if(inviteButton) inviteButton.disabled = true;
                     }
                 }
             };
            
            updateTimer(); 
            timerIntervals[taskField] = setInterval(updateTimer, 1000);
        }
        
        function getTelegramUsername() {
            let username = 'á‰°áŒ«á‹‹á‰½-' + (telegramUserId ? telegramUserId.slice(-4) : Math.floor(Math.random() * 10000)); 
            if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                const user = WebApp.initDataUnsafe.user;
                if (user.username) {
                    username = `@${user.username}`; 
                } else if (user.first_name) {
                    username = user.first_name;
                    if (user.last_name) {
                        username += ` ${user.last_name}`;
                    }
                }
            }
            return username;
        }


        // ======================================================================
        //                          FIREBASE FUNCTIONS
        // ======================================================================
        
        async function firebaseLogin() {
            try {
                const userCredential = await signInAnonymously(auth);
                currentFirebaseUserId = userCredential.user.uid;
                
                            telegramUserId = window.telegramUserId; // áŠ áˆµá‰€á‹µáˆ á‹¨á‰°áŒ«áŠá‹áŠ• 'window.telegramUserId' áŠ¥áŠ•áŒ á‰€áˆ›áˆˆáŠ•

                const userRef = doc(db, 'users', currentFirebaseUserId);
                const userDoc = await getDoc(userRef); // áˆ°áŠá‹± áˆ˜áŠ–áˆ©áŠ• áŠ áˆµá‰€á‹µáˆ áˆ˜áˆá‰°áˆ½

                const username = getTelegramUsername();
                const photo_url = WebApp.initDataUnsafe.user?.photo_url || null;
                
                let referrerId = null;
                if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.start_param) {
                    referrerId = WebApp.initDataUnsafe.start_param;
                    if (referrerId === telegramUserId) {
                        referrerId = null; 
                    }
                }
                
                if (!userDoc.exists()) {
                    // áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆš áŠ¨áˆ†áŠ:
                    await setDoc(userRef, {
                        telegram_id: telegramUserId,
                        username: username, 
                        photo_url: photo_url,
                        created_at: serverTimestamp(),
                        tickets: 0, 
                        total_score: 0, 
                        referrer_id: referrerId || null, // áŠ á‹²áˆµ áŠ¨áˆ†áŠ referral ID áˆ›áˆµá‰€áˆ˜áŒ¥
                        // ğŸ›‘ NEW: áˆˆá‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ á‹¨áˆšá‹«áˆµáˆáˆáŒ‰ áˆ˜áˆ¨áŒƒá‹á‰½
                        daily_streak: 0,
                        last_streak_claim_time: null,
                        // ğŸ›‘ UPDATED: áˆˆ Slot Game á‹¨áˆšá‹«áˆµáˆáˆáŒ‰ áˆ˜áˆ¨áŒƒá‹á‰½
                        slot_spins_left: SLOTS_MAX_SPINS,
                        last_slot_reset_time: null 
                    });
                } else {
                    // áŠá‰£áˆ­ á‰°áŒ á‰ƒáˆš áŠ¨áˆ†áŠ:
                    await setDoc(userRef, {
                        telegram_id: telegramUserId,
                        username: username, 
                        photo_url: photo_url,
                        // referrer_id, created_at, total_score, daily_streak áŠ á‹­áˆ»áˆ»áˆ‰áˆ
                    }, { merge: true });
                }

            } catch (error) {
                WebApp.showAlert("Firebase Login Failed: " + error.message);
                console.error("Firebase Login Failed:", error);
            }
        }


        async function updateScore(coinsToAdd, source, timestampField = null, extraUpdateData = {}) { 
            if (!currentFirebaseUserId) {
                WebApp.showAlert("áŠ¥á‰£áŠ­á‹ áˆ˜á‰°áŒá‰ áˆªá‹«á‹ áŠ¥áˆµáŠªáŒ«áŠ• á‹­áŒ á‰¥á‰ (Login Failed).");
                return false;
            }
            
            const userRef = doc(db, "users", currentFirebaseUserId); 
            
            const updateData = {
                total_score: increment(coinsToAdd), 
                last_played: serverTimestamp(), 
                last_reward_source: source,
                ...extraUpdateData // áŠ¨á‹áŒ­ á‹¨áˆ˜áŒ¡ á‰°áŒ¨áˆ›áˆª áˆ›áˆ»áˆ»á‹«á‹á‰½
            };

            if (timestampField) {
                // áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ«á‰µ áŠ áŠ•á‹µ áŒŠá‹œ á‰¥á‰» á‹¨áˆšáˆ°áˆ© á‰ áˆ˜áˆ†áŠ“á‰¸á‹:
                 if (timestampField.startsWith('last_social_')) {
                    // áˆ°á‹“á‰±áŠ• áŠ«áˆµá‰€áˆ˜áŒ¥áŠ• á‰ áŠ‹áˆ‹ á‹³áŒáˆ áŠ á‹­áˆ°áˆ«áˆ
                    updateData[timestampField] = serverTimestamp(); 
                 } else {
                    // áˆˆá‹•áˆˆá‰³á‹Š á‰°áŒá‰£áˆ«á‰µ (Daily Tasks) á‹¨áŒŠá‹œ áˆ›áˆ…á‰°áˆ áˆ›áˆµá‰€áˆ˜áŒ¥
                    updateData[timestampField] = serverTimestamp();
                 }
            }
            
            try {
                await updateDoc(userRef, updateData); 
                // ğŸ›‘ áŠáŒ¥á‰¡ á‹œáˆ® á‹ˆá‹­áˆ áŠ áˆ‰á‰³á‹Š áŠ¨áˆ†áŠ áˆ›áŠ•á‰‚á‹« áˆ›áˆ³á‹¨á‰µ á‹¨áˆˆá‰¥áŠ•áˆ
                if(coinsToAdd > 0) WebApp.showAlert(`ğŸ‰ ${coinsToAdd.toLocaleString()} coin á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‰°áŒ¨áˆ˜áˆ¨!`); 
                // ğŸ›‘ UPDATED: áŠ®áŠ•áŒá‰²á‹áŠ• áˆ˜á‰°áŠ®áˆµ
                window.triggerConfetti(coinsToAdd); 
                return true;

            } catch (error) {
                if (error.code === 'not-found' || error.message.includes('No document to update')) {
                    const username = getTelegramUsername();
                    const photo_url = WebApp.initDataUnsafe.user?.photo_url || null;
                    
                    const setData = {
                        total_score: coinsToAdd, 
                        username: username,
                        telegram_id: telegramUserId,
                        photo_url: photo_url,
                        last_played: serverTimestamp(), 
                        last_reward_source: source,
                        created_at: serverTimestamp(),
                        tickets: 0, 
                        daily_streak: 0, // ğŸ›‘ NEW: áˆˆá‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ
                        last_streak_claim_time: null, // ğŸ›‘ NEW: áˆˆá‹•áˆˆá‰³á‹Š áˆ½áˆáˆ›á‰µ
                        slot_spins_left: SLOTS_MAX_SPINS, // ğŸ›‘ NEW: áˆˆ Slot Game
                        last_slot_reset_time: null, // ğŸ›‘ NEW: áˆˆ Slot Game
                        // referrer_id áŠ á‹­áŠ«á‰°á‰µáˆ - á‰ áˆ˜áŒ€áˆ˜áˆªá‹«á‹ firebaseLogin á‹áˆµáŒ¥ á‰¥á‰» áˆµáˆˆáˆšáˆ˜á‹˜áŒˆá‰ á‹
                    };

                    if (timestampField) {
                         if (timestampField.startsWith('last_social_')) {
                            setData[timestampField] = serverTimestamp(); 
                        } else {
                            setData[timestampField] = serverTimestamp();
                        }
                    }

                    await setDoc(userRef, setData);
                    if(coinsToAdd > 0) WebApp.showAlert(`ğŸ‰ áŠ á‹²áˆµ áˆ˜áˆ¨áŒƒ á‰°áˆáŒ áˆ¨ áŠ¥áŠ“ ${coinsToAdd.toLocaleString()} coin á‰°áŒ¨áˆ˜áˆ¨!`); // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin
                    // ğŸ›‘ UPDATED: áŠ®áŠ•áŒá‰²á‹áŠ• áˆ˜á‰°áŠ®áˆµ
                    window.triggerConfetti(coinsToAdd); 
                    return true;
                } else {
                    WebApp.showAlert("âŒ coin á‰ áˆ›á‹˜áˆ˜áŠ• áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ áˆ¨: " + error.message); // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin
                    console.error("Error updating score:", error);
                    return false;
                }
            }
        }
        
        // ğŸ›‘ NEW: á‰²áŠ¬á‰¶á‰½áŠ• (coin) áˆ›á‹˜áˆ˜áŠ• (áŠ áˆá‰°á‹ˆáŒˆá‹°áˆ - áˆˆáˆŒáˆá‰½ áŠ­ááˆá‰½ áŒ á‰ƒáˆš áˆŠáˆ†áŠ• á‹­á‰½áˆ‹áˆ)
        async function updateTickets(ticketsToAdd) {
             if (!currentFirebaseUserId) {
                WebApp.showAlert("áŠ¥á‰£áŠ­á‹ áˆ˜á‰°áŒá‰ áˆªá‹«á‹ áŠ¥áˆµáŠªáŒ«áŠ• á‹­áŒ á‰¥á‰ (Login Failed).");
                return false;
            }
            
            const userRef = doc(db, "users", currentFirebaseUserId); 
            
            const updateData = {
                tickets: increment(ticketsToAdd), 
            };
            
            try {
                await updateDoc(userRef, updateData); 
                WebApp.showAlert(`ğŸ‰ ${ticketsToAdd.toLocaleString()} Teto (Ticket) á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ á‰°áŒ¨áˆ˜áˆ¨!`);
                return true;
            } catch (error) {
                 WebApp.showAlert("âŒ á‰²áŠ¬á‰µ (coin) á‰ áˆ›á‹˜áˆ˜áŠ• áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ áˆ¨: " + error.message);
                 console.error("Error updating tickets:", error);
                 return false;
            }
        }
/**
 * á‹¨FireStoreáŠ• á‹¨"users" áˆµá‰¥áˆµá‰¥ á‰ áˆ›á‹³áˆ˜áŒ¥ á‹¨áˆŠá‹°áˆ­á‰¦áˆ­á‹±áŠ• áˆ˜áˆ¨áŒƒ á‰ áŠ¥á‹áŠá‰°áŠ› áŒŠá‹œ á‹«á‹˜áˆáŠ“áˆá¢
 * áˆ›áˆµá‰°áŠ«áŠ¨á‹«:
 * 1. 'Function' á‹ˆá‹° 'function' (Syntax Error á‰°áˆµá‰°áŠ«áŠ­áˆáˆ).
 * 2. á‹¨á‹°áˆ¨áŒƒ á‰áŒ¥áˆ©áŠ• á‰ á‰µáŠ­áŠ­áˆ áˆˆáˆ˜á‰áŒ áˆ­ 'rankCounter' á‰°áŒ¨áˆáˆ¯áˆ (Rank Error á‰°áˆµá‰°áŠ«áŠ­áˆáˆ).
 */
function setupLeaderboardListener() {
    const usersCollectionRef = collection(db, "users");
    // á‰  'total_score' á‰ á‰…á‹°áˆ á‰°áŠ¨á‰°áˆ á‰ áˆ˜á‹°áˆ­á‹°áˆ­ á‹¨áˆ˜áŒ€áˆ˜áˆªá‹«á‹á‰¹áŠ• 50 á‰°áŒ á‰ƒáˆšá‹á‰½ áŠ¥áŠ•áŒˆá‹°á‰£áˆˆáŠ•
    const q = query(usersCollectionRef, orderBy('total_score', 'desc'), limit(100)); 
    
    onSnapshot(q, (snapshot) => {
        let players = [];
        let foundUserRank = '0'; 
        
        // ğŸ›‘ áˆ›áˆµá‰°áŠ«áŠ¨á‹« 1: á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• á‹°áˆ¨áŒƒ áˆˆáˆ˜á‰áŒ áˆ­ á‹áŒ«á‹Š á‰†áŒ£áˆª áŠ¥áŠ•áŒ á‰€áˆ›áˆˆáŠ•
        let rankCounter = 0; 
        
        snapshot.forEach((doc) => {
            const data = doc.data();
            
            // ğŸ›‘ áˆ›áˆµá‰°áŠ«áŠ¨á‹« 2: á‰†áŒ£áˆªá‹áŠ• áŒ¨áˆáˆ¨áŠ• á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• á‹¨á‹°áˆ¨áŒƒ á‰áŒ¥áˆ­ áŠ¥áŠ•áˆ°áŒ£áˆˆáŠ•
            rankCounter++;
            const rank = rankCounter; 
            
            players.push({ id: doc.id, ...data, rank: rank });

            if (doc.id === currentFirebaseUserId) {
                currentScore = data.total_score || 0; 
                currentTickets = data.tickets || 0; 
                currentUserDocData = data; 
                foundUserRank = `#${rank}`; 
                
                // á‹¨ Slot Game áˆáŠ”á‰³áŠ• áŠ¨ Firebase áˆ›áŒáŠ˜á‰µ
                currentSpinsLeft = data.slot_spins_left !== undefined ? data.slot_spins_left : SLOTS_MAX_SPINS;
            }
        });
        
        currentRank = foundUserRank;
        
        let leaderboardHTML = `<div id="leaderboard-list">`;
        
        if (players.length === 0) {
             leaderboardHTML += '<p style="text-align: center; color: var(--tg-hint); padding: 10px;">á‰µáŠ•áˆ½ á‹­áŒ á‰¥á‰á¢</p>';
        } else {
            players.forEach((player) => {
                const isCurrentUser = player.id === currentFirebaseUserId;
                const avatarHtml = getAvatarHtml(player.username, player.photo_url); 
                
                // á‰µáŠ­áŠ­áˆˆáŠ›á‹ á‹¨á‹°áˆ¨áŒƒ áŠ áˆ˜áŠ­áŠ•á‹®
                let rankClass = '';
                let rankDisplay; 
                
                const rankNumber = Number(player.rank); 
                
                // NaN á‹ˆá‹­áˆ 0 áŠ¨áˆ†áŠ #? á‹­áˆáŠ• (á‹­áˆ… #? á‹¨áˆšáˆˆá‹áŠ• á‰½áŒáˆ­ á‹­áˆá‰³áˆ)
                if (isNaN(rankNumber) || rankNumber < 1) {
                    rankDisplay = '#?';
                    rankClass = '';
                } else {
                    // áˆˆ Top 3 áˆœá‹³áˆŠá‹«á‹á‰½áŠ• áŠ¥áŠ“ áŠ­áˆ‹áˆµáŠ• áˆ˜á‹ˆáˆ°áŠ•
                    if (rankNumber === 1) {
                        rankClass = 'gold-highlight';
                        rankDisplay = 'ğŸ¥‡'; // Gold Medal
                    } else if (rankNumber === 2) {
                        rankClass = 'silver-highlight';
                        rankDisplay = 'ğŸ¥ˆ'; // Silver Medal
                    } else if (rankNumber === 3) {
                        rankClass = 'bronze-highlight';
                        rankDisplay = 'ğŸ¥‰'; // Bronze Medal
                    } else {
                        // áŠ¨ 3áŠ› á‹°áˆ¨áŒƒ á‰ áˆ‹á‹­ áˆ‹áˆ‰á‰µ: á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• á‰áŒ¥áˆ­ á‰ áŠáŒ¥á‰¥ áŠ¥áŠ•á‹²á‹«áˆ³á‹­
                        rankDisplay = rankNumber.toString() + '.'; 
                        rankClass = ''; 
                    }
                }
                
                // á‹¨áŠ áˆáŠ‘ á‰°áŒ á‰ƒáˆšáˆ áŠ¨áˆ†áŠ áˆáˆˆá‰±áŠ•áˆ áŠ­áˆ‹áˆ¶á‰½ á‹­á‹áˆ°á‹µ
                const itemClasses = `${isCurrentUser ? 'current-user-highlight' : ''} ${rankClass}`;
                // rankHtmlClass á‹¨áˆšá‹áˆˆá‹ áˆˆáˆœá‹³áˆŠá‹«á‹á‰¹ á‰€áˆˆáˆ á‰¥á‰» áŠá‹
                const rankHtmlClass = (rankNumber === 1) ? 'gold' : (rankNumber === 2) ? 'silver' : (rankNumber === 3) ? 'bronze' : '';


                leaderboardHTML += `
                    <div class="leaderboard-item ${itemClasses}">
                        <span class="leaderboard-item-rank ${rankHtmlClass}">
                            ${rankDisplay} 
                        </span> 
                        <div class="leaderboard-item-photo">${avatarHtml}</div> 
                        <span class="leaderboard-item-name">${player.username || 'á‹«áˆá‰³á‹ˆá‰€ á‰°áŒ«á‹‹á‰½'}</span>
                        <span class="leaderboard-item-score">${(player.total_score || 0).toLocaleString()} ğŸ’°</span>
                    </div>
                `;
            });
        }
          
        leaderboardHTML += `</div>`;
        
        const leaderboardContainer = document.getElementById('leaderboard-container');
        if (leaderboardContainer) {
            leaderboardContainer.innerHTML = leaderboardHTML;
        }
        
        renderPageContent();

    }, (error) => {
        console.error("Error fetching leaderboard:", error);
        document.getElementById('leaderboard-container').innerHTML = '<p style="text-align: center; color: var(--et-red); padding: 10px;">á‹¨áˆ°áŠ•áŒ áˆ¨á‹¡áŠ• áˆ˜áˆ¨áŒƒ á‰ áˆ›áˆáŒ£á‰µ áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ áˆ¨á¢</p>';
    });
}

        // ======================================================================
        //                          PAGE NAVIGATION FUNCTIONS
        // ======================================================================

        window.switchPage = (pageIdToShow) => {
            // ğŸ›‘ UPDATED: 'slots-game-page' á‰°áŒ¨áˆáˆ¯áˆ
            const mainPages = ['tasks-page', 'top-page', 'profile-page'];
            const gamePages = [
                'mystery-box-page',
                'daily-spin-page',
                'reflex-game-page',
                'withdraw-page',
                'exchange-page',
                'social-tasks-page',
                'slots-game-page',
                'scratch-card-page' // ğŸ›‘ áŠ á‹²áˆµ á‹¨á‰°áŒ¨áˆ˜áˆ¨
            ];
            const allPages = [...mainPages, ...gamePages];
            
            allPages.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            const targetPage = document.getElementById(pageIdToShow);
            if (targetPage) {
                targetPage.style.display = 'block';
            }

            mainPages.forEach(id => {
                const navItem = document.getElementById(`nav-${id.split('-')[0]}`);
                if (navItem) {
                    navItem.classList.remove('active');
                }
            });
            
            if (mainPages.includes(pageIdToShow)) {
                const navItem = document.getElementById(`nav-${pageIdToShow.split('-')[0]}`);
                if (navItem) {
                    navItem.classList.add('active');
                }
                 // á‰ á‹‹áŠ“ áŒˆáŒ¾á‰½ áˆ‹á‹­ á‹¨áŠ‹áˆ‹ á‰áˆá áŠ á•áˆŠáŠ¬áˆ½áŠ‘áŠ• áŠ¥áŠ•á‹²á‹˜áŒ‹ á‹«á‹°áˆ­áŒ‹áˆ
                 WebApp.BackButton.hide();
                 WebApp.BackButton.onClick(() => WebApp.close()); 

            } else {
                // á‰ áŠ•áŠ¡áˆµ áŒˆáŒ¾á‰½ áˆ‹á‹­ á‹¨áŠ‹áˆ‹ á‰áˆá á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‹­áˆ˜áˆáˆ³áˆ
                WebApp.BackButton.show();
                // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: showMainPage() áŠ¨ global scope á‰°áŒ á‰…áˆŸáˆ
                WebApp.BackButton.onClick(window.showMainPage);
            }
            
            if (pageIdToShow === 'tasks-page') {
                 // ğŸ›‘ NEW: á‹¨áˆ˜áŒ‹á‰ á‹£ á‰áˆá á‰†áŒ£áˆªáŠ• áˆ›áˆµáŒ€áˆ˜áˆ­
                 startCooldownTimer('last_invite_time', null, 'invite-button'); 
                
                // ğŸ›‘ áŠ á‹²áˆµ: á‹¨áŠ«áˆ­á‹µ á‰£áŒ… áˆ›á‹˜áˆ˜áŠ•
                updateTaskCardStatus('mystery-box-card', 'mystery-box-badge', 'last_mystery_time');
                updateTaskCardStatus('daily-spin-card', 'daily-spin-badge', 'last_spin_time');
                updateTaskCardStatus('reflex-game-card', 'reflex-game-badge', 'last_reflex_time');
                // ğŸ›‘ NEW: áˆˆ Slot Game Card áˆ›á‹˜áˆ˜áŠ•
                updateTaskCardStatus('slots-game-card', 'slots-game-badge', SLOTS_COOLDOWN_FIELD);
                
                // á‹¨áŠ«áˆ­á‹µ á‰£áŒ†á‰½áŠ• á‰ á‹¨áŒŠá‹œá‹ áŠ¥áŠ•á‹²á‹«á‹˜áˆáŠ• áˆ›á‹µáˆ¨áŒ
                if (!timerIntervals['card_status_update']) {
                    timerIntervals['card_status_update'] = setInterval(() => {
                        updateTaskCardStatus('mystery-box-card', 'mystery-box-badge', 'last_mystery_time');
                        updateTaskCardStatus('daily-spin-card', 'daily-spin-badge', 'last_spin_time');
                        updateTaskCardStatus('reflex-game-card', 'reflex-game-badge', 'last_reflex_time');
                        // ğŸ›‘ NEW: áˆˆ Slot Game Card
                        updateTaskCardStatus('slots-game-card', 'slots-game-badge', SLOTS_COOLDOWN_FIELD);
                    }, 5000); 
                }

            } else {
                 // á‹¨áŠ«áˆ­á‹µ á‰£áŒ… áˆ›áˆ»áˆ»á‹«á‹áŠ• áŠ á‰áˆ
                if (timerIntervals['card_status_update']) {
                    clearInterval(timerIntervals['card_status_update']);
                    delete timerIntervals['card_status_update'];
                }

                if (pageIdToShow === 'mystery-box-page') {
                    startCooldownTimer('last_mystery_time', 'mystery-box-timer', 'mystery-box-action');
                    window.resetMysteryBox(false); 
                } else if (pageIdToShow === 'daily-spin-page') {
                    startCooldownTimer('last_spin_time', 'daily-spin-timer', 'daily-spin-action');
                } else if (pageIdToShow === 'reflex-game-page') {
                    startCooldownTimer('last_reflex_time', 'reflex-game-timer', 'reflex-game-action');
                    window.resetReflexGame(false); 
                    isReflexGameRunning = false; 
                    window.document.getElementById('reflex-play-area').onclick = window.handleReflexTooEarlyClick;
                } else if (pageIdToShow === 'social-tasks-page') {
                     // ğŸ›‘ NEW: á‹¨áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ­ áˆáŠ”á‰³á‹á‰½áŠ• áˆ›á‹˜áˆ˜áŠ•
                    updateSocialTaskStatus('channel-action', 'https://t.me/Smart_Airdropss', 1500, 'last_social_tg_channel_time', 'join'); // ğŸ›‘ points á‹ˆá‹° coins
                    updateSocialTaskStatus('group-action', 'https://t.me/school_library2012', 1000, 'last_social_tg_group_time', 'join'); // ğŸ›‘ points á‹ˆá‹° coins
                    updateSocialTaskStatus('youtube-action', 'https://www.youtube.com/', 3000, 'last_social_youtube_time', 'subscribe'); // ğŸ›‘ points á‹ˆá‹° coins
                } else if (pageIdToShow === 'exchange-page') {
                    const pointsInput = document.getElementById('exchangePointsInput');
                    if (pointsInput) pointsInput.value = '';
                    const changeButton = document.getElementById('finalChangeButton');
                    if (changeButton) {
                        changeButton.disabled = true;
                        changeButton.style.backgroundColor = '#a0a0a0';
                        changeButton.style.cursor = 'not-allowed';
                    }
                    const exchangeMessage = document.getElementById('exchangeMessage');
                    if (exchangeMessage) exchangeMessage.innerText = '';
                } else if (pageIdToShow === 'slots-game-page') {
                     // ğŸ›‘ NEW: áˆˆ Slot Game áŒˆáŒ½
                     window.updateSlotGameUI();
                     // á‹¨ Slot Game á‹³áŒáˆ áˆ›áˆµáŒ€áˆ˜áˆ­ á‰†áŒ£áˆªáŠ• áˆ›áˆµáŒ€áˆ˜áˆ­
                     startCooldownTimer(SLOTS_COOLDOWN_FIELD, 'reset-timer', 'spin-btn');
                
                } else if (pageIdToShow === 'scratch-card-page') { // ğŸ›‘ áŠ á‹²áˆµ á‹¨á‰°áŒ¨áˆ˜áˆ¨
                    // á‹¨ Scratch Card áŒ¨á‹‹á‰³á‹áŠ• á‹«áˆµáŒ€áˆáˆ©
                    window.initScratchCard(false); 
                }
            }
            
            renderPageContent();
        }

        // ğŸ›‘ showMainPage() á‹ˆá‹° áˆµáŠ­áˆªá•á‰µ áˆ˜áŒ€áˆ˜áˆªá‹« (áŠ¨ module á‹áŒª) á‰°áŠ•á‰€áˆ³á‰…áˆ·áˆ

        window.handleCardClick = (pageId) => {
            switchPage(pageId);
        }

        window.handleTaskClick = async (taskName, coins, timestampField) => { // ğŸ›‘ points á‹ˆá‹° coins
            const { isReady } = checkDailyLimit(timestampField);
            if (!isReady) {
                WebApp.showAlert(`âŒ ${taskName} áˆˆ 24 áˆ°á‹“á‰µ á‰¥á‰» á‹­áˆ°áŒ£áˆá¢ áŠ¥á‰£áŠ­á‹ áŒŠá‹œ áŠ¥áˆµáŠªáŒ áŠ“á‰€á‰… á‹­áŒ á‰¥á‰á¢`);
                return;
            }
            await updateScore(coins, taskName, timestampField); // ğŸ›‘ points á‹ˆá‹° coins
            renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
        }

        // ğŸ›‘ NEW: á‹¨áˆ›áˆ…á‰ áˆ«á‹Š á‰°áŒá‰£áˆ«á‰µ áŠ á‹«á‹«á‹
        window.handleSocialTaskClick = async (button, actionType) => {
            const link = button.getAttribute('data-link');
            const coins = parseInt(button.getAttribute('data-points')); // ğŸ›‘ data-points á‰°áŒ á‰…áˆŸáˆ
            const field = button.getAttribute('data-field');
            const taskName = button.getAttribute('data-name');
            
            const { hasCompleted } = checkDailyLimit(field);

            if (hasCompleted) {
                WebApp.showAlert(`âœ… á‹­áˆ…áŠ• á‰°áŒá‰£áˆ­ (${taskName}) áŠ áˆµá‰€á‹µáˆ˜á‹ áŠ áŒ áŠ“á‰€á‹‹áˆá¢`);
                return;
            }

            if (button.innerText.includes('Join') || button.innerText.includes('Subscribe')) {
                // 1. áˆ˜áŒ€áˆ˜áˆªá‹« áˆŠáŠ•áŠ©áŠ• á‹­áŠ­áˆá‰µ
                if (link.includes('t.me/')) {
                     WebApp.openTelegramLink(link);
                } else {
                     WebApp.openLink(link);
                }
                
                // 2. áŠ á‹áˆ«áˆ©áŠ• á‹ˆá‹° Complete áŠ¥áŠ•á‹²áŒ«áŠ‘á‰µ á‹¨áˆšáŒ á‹­á‰… áˆ˜áˆáŠ­ á‹­áˆˆá‹áŒ¥
                const actionText = actionType === 'subscribe' ? 'Subscribed' : 'Joined';
                button.innerText = `Complete (${actionText})`;
                button.onclick = () => window.handleSocialTaskClick(button, actionType); // áˆˆá‹µáŒ‹áˆš áŠ­áˆŠáŠ­ áˆ«áˆ±áŠ• áŠ¥áŠ•á‹²áŒ áˆ«
                
                // 3. áˆ˜áˆá‹•áŠ­á‰µ áˆ›áˆ³á‹¨á‰µ
                WebApp.showAlert(`âœ… áŠ¥á‰£áŠ­á‹áŠ• á‰»áŠ“áˆ‰áŠ•/á‰¡á‹µáŠ‘áŠ•/á‹©á‰²á‹©á‰¥áŠ• áŠ¨á‰°á‰€áˆ‹á‰€áˆ‰ á‰ áŠ‹áˆ‹ coiná‹áŠ• áˆˆáˆ˜á‹áˆ°á‹µ 'Complete' á‹¨áˆšáˆˆá‹áŠ• á‰áˆá á‹­áŒ«áŠ‘á¢`); // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin

            } else if (button.innerText.includes('Complete')) {
                // 4. áŠ áˆáŠ• coináŠ• áˆ˜áˆµáŒ á‰µ
                if (await updateScore(coins, taskName, field)) { // ğŸ›‘ points á‹ˆá‹° coins
                    // 5. á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŠ¨á‰°áˆ°áŒ  á‰ áŠ‹áˆ‹ áˆáŠ”á‰³á‹áŠ• áˆ˜á‰€á‹¨áˆ­
                    button.innerText = `Completed âœ…`;
                    button.classList.remove('join-style');
                    button.classList.add('completed-style');
                    button.onclick = null;
                    button.disabled = true;
                    renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
                }
            }
        };


        // ======================================================================
        // ğŸ›‘ UPDATED: á‹¨á‰°áˆ»áˆ»áˆˆá‹ á‹¨áŒ“á‹°áŠ› áŒ‹á‰¥á‹ á‰°áŒá‰£áˆ­ (Telegram Share Integration)
        // ======================================================================
    // ... (áˆŒáˆá‰½ á‰°áŒá‰£áˆ«á‰µ áŠ¥áŠ•á‹° formatTime, checkDailyLimit, updateScore, startCooldownTimer, renderPageContent áŠ¥á‹šáˆ… áˆ˜áŒˆáˆˆáŒ½ áŠ áˆˆá‰£á‰¸á‹)

// á‹¨á‰´áˆŒáŒáˆ«áˆ á‰¦á‰µ á‹©á‹˜áˆ­áŠ”áˆ (á‰ áŠ¥áˆ­áˆµá‹ á‰µáŠ­áŠ­áˆˆáŠ› á‹¨á‰¦á‰µ áˆµáˆ áˆ˜á‰°áŠ«á‰µá‹áŠ• á‹«áˆ¨áŒ‹áŒáŒ¡!)
const BOT_USERNAME = 'Smartgame21_bot'; 

// ======================================================================
// 1. ğŸ’¼ á‹¨ Wallet áˆ›áŒˆáŠ“áŠ› á‰°áŒá‰£áˆ­ (Handle Wallet Connect)
// ğŸŸ¢ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: openTelegramLink á‰  openLink á‰°á‰°áŠ«
// ======================================================================

window.handleWalletConnect = () => {
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            
            // ğŸ›‘ áŠ á‹²áˆµ á‹¨áˆ›áŒˆáŠ“áŠ› áˆŠáŠ•áŠ­á¡ 
            // á‹ˆá‹° á‰´áˆŒáŒáˆ«áˆ Wallet Bot (Crypto Wallet) á‹áˆµáŒ¥ á‹«áˆˆá‹áŠ• á‹¨á‰¶áŠ• áŠªáˆµ á‰¦áˆ­áˆ³ á‹­áŠ¨áá‰³áˆá¢
            // á‹­áˆ…áŠ•áŠ• á‹©áŠ áˆ­áŠ¤áˆ á‰ áˆ˜áŒ á‰€áˆ á‰°áŒ á‰ƒáˆšá‹ á‹ˆá‹° Wallet Bot á‹­áˆ‹áŠ­áŠ“ á‹¨áˆ›áŒˆáŠ“áŠ˜á‰µ áˆáˆ­áŒ« á‹­áˆ°áŒ á‹‹áˆá¢
            const walletBotLink = 'https://t.me/wallet?startapp=ton-connect-default'; 
            
            // á‹¨á‰´áˆŒáŒáˆ«áˆ SDKáŠ• á‰ áˆ˜áŒ á‰€áˆ á‹áŒ«á‹Š áˆŠáŠ•áŠ­ á‹­áŠ¨áá‰³áˆ (á‰ In-app Browser/Pop-up)
            // á‹­áˆ… Deep Link Wallet Bot áŠ¥áŠ•á‹²áŠ¨áá‰µ á‹­áˆ¨á‹³áˆá¢
            window.Telegram.WebApp.openLink(walletBotLink);
            
            // áˆˆá‰°áŒ á‰ƒáˆšá‹ áˆ›áˆ³á‹ˆá‰‚á‹« áˆ˜áˆµáŒ á‰µ (áŠ áˆ›áˆ«áŒ­)
            WebApp.showAlert("Wallet Bot áŠ¥á‹¨á‰°áŠ¨áˆá‰° áŠá‹á¢ áŠ¥á‰£áŠ­á‹ á‰  Wallet Bot á‹áˆµáŒ¥ 'Connect' á‹¨áˆšáˆˆá‹áŠ• á‹­áŒ«áŠ‘á¢");

        } else {
            console.error("Telegram WebApp API is not ready or available.");
            alert("á‹­áˆ… á‰°áŒá‰£áˆ­ á‰ á‰´áˆŒáŒáˆ«áˆ áˆšáŠ’ áŠ á• á‹áˆµáŒ¥ á‰¥á‰» áŠá‹ á‹¨áˆšáˆ°áˆ«á‹á¢");
        }
    } catch (error) {
        if (window.Telegram && window.Telegram.WebApp) {
             WebApp.showAlert("Wallet Link áˆ˜áŠ­áˆá‰µ áŠ áˆá‰°á‰»áˆˆáˆ: " + error.message);
        } else {
             alert("Wallet Link áˆ˜áŠ­áˆá‰µ áŠ áˆá‰°á‰»áˆˆáˆ: " + error.message);
        }
        console.error("Error opening Telegram link:", error);
    }
};

// ======================================================================
// 2. ğŸ”— á‹¨áˆ˜áŒ‹á‰ á‹£ áˆŠáŠ•áŠ­ áˆ˜á‰…áŒƒ á‰°áŒá‰£áˆ­ (Handle Copy Invite Link)
// ğŸ›‘ FIX 1: áŠ áˆáŠ• á‹­áˆ°áˆ«áˆ (á‰  firebaseLogin() á‹áˆµáŒ¥ á‰£áˆˆá‹ áˆ›áˆµá‰°áŠ«áŠ¨á‹«)
// ======================================================================

window.handleCopyInviteLink = () => {
    // telegramUserId á‹¨áˆšáˆˆá‹ á‰°áˆˆá‹‹á‹‹áŒ­ áˆ˜áŒ«áŠ‘áŠ• á‹«áˆ¨áŒ‹áŒáŒ£áˆ (á‰ áŠ¥áˆ­áˆµá‹ áŠ®á‹µ á‹áˆµáŒ¥ global áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µ)
    if (!window.telegramUserId) { // ğŸ›‘ FIX 1: á‹­áˆ… áŠ áˆáŠ• á‰  firebaseLogin() áˆáŠ­áŠ•á‹«á‰µ á‰ á‰µáŠ­áŠ­áˆ á‹­áˆ°áˆ«áˆ
        WebApp.showAlert("áˆ˜áˆ¨áŒƒá‹ áŒˆáŠ“ áŠ áˆá‰°áŒ«áŠáˆá¢ áŠ¥á‰£áŠ­á‹ á‰µáŠ•áˆ½ á‰†á‹­á‰°á‹ á‹­áˆáŠ­áˆ©á¢");
        return;
    }
    
    // á‹¨áˆ˜áŒ‹á‰ á‹£ áˆŠáŠ•áŠ©áŠ• á‹­áˆáŒ¥áˆ«áˆ
    const referralLink = `https://t.me/${BOT_USERNAME}?start=${window.telegramUserId}`;

    // áˆŠáŠ•áŠ©áŠ• á‹ˆá‹° Clipboard áˆ˜á‰…á‹³á‰µ
    navigator.clipboard.writeText(referralLink).then(() => {
        WebApp.showAlert("âœ… á‹¨áˆ˜áŒ‹á‰ á‹£ áˆŠáŠ•áŠ­ á‰°á‰€á‹µá‰·áˆ!");
    }).catch(err => {
        console.error('Failed to copy link: ', err);
        WebApp.showAlert("âŒ áˆŠáŠ•áŠ©áŠ• áˆ˜á‰…á‹³á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢");
    });
};

// ======================================================================
// 3. ğŸ‘¥ á‹¨á‰°áˆ»áˆ»áˆˆá‹ á‹¨áŒ“á‹°áŠ› áŒ‹á‰¥á‹/Share á‰°áŒá‰£áˆ­ (Handle Invite Click) ğŸ›‘ áˆ½áˆáˆ›á‰µ á‰°á‹ˆáŒá‹·áˆ
// ======================================================================

window.handleInviteClick = (inviteLink, coins, timestampField) => { 
    // áˆ½áˆáˆ›á‰± á‰ á‰¦á‰µ/áˆ°áˆ­á‰¨áˆ­ Logic áˆµáˆˆáˆšáˆ°áŒ¥á£ á‹¨ 24-áˆ°á‹“á‰µ á‰†áŒ£áˆª áŠ¥áŠ“ updateScore á‰°á‹ˆáŒá‹·áˆ
    
    // ğŸ›‘ FIX 1: window.telegramUserId áŠ áˆáŠ• á‰ á‰µáŠ­áŠ­áˆ á‹­áˆ°áˆ«áˆ
    const currentUserId = window.telegramUserId || 'MOCK_USER';
    
    // á‹¨á‰´áˆŒáŒáˆ«áˆ Referral áˆŠáŠ•áŠ­ áˆ˜ááŒ áˆ­
    const referralLink = `https://t.me/${BOT_USERNAME}?start=${currentUserId}`; 

    const messageText = encodeURIComponent(`â€‹ğŸ¤« áˆšáˆµáŒ¥áˆ©áŠ• áˆáŠ•áŒˆáˆ­áˆ…?
â€‹á‰´áˆŒáŒáˆ«áˆ áˆ‹á‹­ á‰¥á‹™ áˆ°á‹á‰½ á‹¨áˆ›á‹«á‹á‰á‰µ Coin áˆ˜ááˆˆá‰‚á‹« áˆšáŠ’-áŠ á• áŠ áŒáŠá‰»áˆˆáˆ!
â€‹á‹­áˆ„ áŒŒáˆ áŠ á‹­á‹°áˆˆáˆâ€”áŠ¥á‹áŠá‰°áŠ› á‹•á‹µáˆ áŠá‹!
â€‹ğŸ’¡ áŠ¥áŠ”áŠ“ áŒ“á‹°áŠá‰¼ áŠ áˆáŠ• á‰ áŒáŠ•á‰£áˆ­ á‰€á‹°áˆá‰µáŠá‰µ áŒ€áˆáˆ¨áŠ“áˆ! á‰ áŠ‹áˆ‹ áŠ¥áŠ•á‹³á‰µá‰†áŒ­!
â€‹áŠ áˆáŠ‘áŠ‘ á‰°á‰€áˆ‹á‰…áˆˆáˆ… á‹¨á‹µáˆ áˆ˜áŠ•áŒˆá‹±áŠ• áŒ€áˆáˆ­:`); 

    // á‹¨á‰´áˆŒáŒáˆ«áˆ áˆ¼áˆ­ á‹©áŠ áˆ­áŠ¤áˆ
    const shareLink = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${messageText}`;

    
    // á‰°áŒ á‰ƒáˆšá‹áŠ• á‹ˆá‹° á‰´áˆŒáŒáˆ«áˆ áˆ˜áŒ‹áˆªá‹« áˆ˜á‹áˆ°á‹µ (Share)
    WebApp.openTelegramLink(shareLink); 
    
    // á‰°áŒ á‰ƒáˆšá‹ áŠ¥áŠ•á‹²á‹«áŒ‹áˆ« áˆˆáˆ›á‰ áˆ¨á‰³á‰³á‰µ áˆ›áˆ³á‹ˆá‰‚á‹« áˆ˜áˆµáŒ á‰µ
    WebApp.showAlert("âœ… áŠ¥á‰£áŠ­á‹ áˆŠáŠ•áŠ©áŠ• áˆˆáŒ“á‹°áŠá‰½á‹ Share á‰ áˆ›á‹µáˆ¨áŒ áŠ¥áŠ•á‹²á‰€áˆ‹á‰€áˆ‰ á‹­áŒ‹á‰¥á‹™!"); 
};


// ======================================================================
// ğŸ›‘ FIX 3 & 4: áˆˆ Support áŠ¥áŠ“ Close áŠ á‹áˆ«áˆ®á‰½ á‹¨á‰°áŒ¨áˆ˜áˆ© á‰°áŒá‰£áˆ«á‰µ
// ======================================================================

/**
 * 3. ğŸ’¼ Support Button Function
 * (á‹­áˆ…áŠ•áŠ• á‰°áŒá‰£áˆ­ á‰  HTML á‹áˆµáŒ¥ áŠ«áˆˆá‹á‰µ á‹¨ Support áŠ á‹áˆ«áˆ­ áŒ‹áˆ­ á‹«áŒˆáŠ“áŠ™á‰µ)
 * e.g., <button onclick="window.handleSupportClick()">Support</button>
 */
window.handleSupportClick = () => {
    // ğŸ›‘ áŠ¥á‰£áŠ­á‹áŠ• 'YourSupportUsername' á‹¨áˆšáˆˆá‹áŠ• á‰ á‰µáŠ­áŠ­áˆˆáŠ›á‹ á‹¨á‹µáŒ‹á áŠ áŠ«á‹áŠ•á‰µ áˆµáˆ á‹­á‰°áŠ©
    const SUPPORT_LINK = 'https://t.me/smartgameSupporter_bot'; // ğŸ‘ˆ áŠ¥á‰£áŠ­á‹áŠ• á‹­áˆ…áŠ•áŠ• á‹­á‰°áŠ©
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            WebApp.openTelegramLink(SUPPORT_LINK);
        } else {
            alert('Support can only be accessed within the Telegram app.');
            window.open(SUPPORT_LINK, '_blank'); // Fallback for browsers
        }
    } catch (e) {
        WebApp.showAlert('Could not open support link: ' + e.message);
    }
};

/**
 * 4. âŒ Close Button Function
 * (á‹­áˆ…áŠ•áŠ• á‰°áŒá‰£áˆ­ á‰  HTML á‹áˆµáŒ¥ áŠ«áˆˆá‹á‰µ á‹¨á‹áŒ‹ áŠ á‹áˆ«áˆ­ áŒ‹áˆ­ á‹«áŒˆáŠ“áŠ™á‰µ)
 * e.g., <button onclick="window.handleCloseClick()">Close</button>
 */
window.handleCloseClick = () => {
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            WebApp.close(); // áˆ˜á‰°áŒá‰ áˆªá‹«á‹áŠ• á‹­á‹˜áŒ‹áˆ
        } else {
            alert('This can only be closed from within the Telegram app.');
        }
    } catch (e) {
        WebApp.showAlert('Error closing app: ' + e.message);
    }
};


        // ======================================================================
        // ğŸ›‘ á‹¨áŒ“á‹°áŠ› áŒ‹á‰¥á‹ á‰°áŒá‰£áˆ­ áˆ˜áŒ¨áˆ¨áˆ»
        // ======================================================================


        // ğŸ›‘ FIX 2: áŠ¥áŠá‹šáˆ… áŠ¨á‰³á‰½ á‹¨áŠá‰ áˆ©á‰µ á‹¨á‰°á‹°áŒ‹áŒ‹áˆš (Duplicate) á‰°áŒá‰£áˆ«á‰µ á‰°á‹ˆáŒá‹°á‹‹áˆ
        /*
        window.handleWalletConnect = () => { ... };
        window.handleWalletConnect = () => { ... };
        window.handleCopyInviteLink = () => { ... };
        */


        // ======================================================================
        //                          DAILY STREAK MODAL CODE ğŸ›‘ NEW SECTION
        // ======================================================================



        // ======================================================================
//                          DAILY STREAK MODAL CODE ğŸ›‘ NEW SECTION
// ======================================================================
        
// áˆ½áˆáˆ›á‰± (streak) á‹¨áˆšá‰‹áˆ¨áŒ¥á‰ á‰µáŠ• áŒŠá‹œ á‰ áˆ°á‹“á‰µ á‹­á‹ˆáˆµáŠ“áˆ (48 áˆ°á‹“á‰µ = 2 á‰€áŠ•)
const STREAK_BREAK_HOURS = 48; 

window.openDailyRewardModal = () => {
    document.getElementById('daily-reward-modal').style.display = 'flex';
    window.updateDailyRewardModal();
}

window.closeDailyRewardModal = () => {
    document.getElementById('daily-reward-modal').style.display = 'none';
     // áˆá‹³áˆ áˆ²á‹˜áŒ‹ á‹¨áŒŠá‹œ á‰†áŒ£áˆªá‹áŠ• áˆ›á‰†áˆ
    if (timerIntervals['daily_streak_timer']) {
        clearInterval(timerIntervals['daily_streak_timer']);
        delete timerIntervals['daily_streak_timer'];
    }
}

/**
 * á‹¨ Streak áˆ˜á‰‹áˆ¨áŒ¥áŠ• (break) á‹­áˆá‰µáˆ»áˆ
 */
const checkStreakBroken = (lastClaimTimestamp) => {
    if (!lastClaimTimestamp) {
        return false; // áŒˆáŠ“ áˆáŠ•áˆ claim áŠ áˆ‹á‹°áˆ¨áŒˆáˆ
    }
    const lastClaimTime = lastClaimTimestamp.toDate(); // Timestamp á‹ˆá‹° Date á‰€á‹­áˆ­
    const now = new Date();
    const hoursElapsed = (now.getTime() - lastClaimTime.getTime()) / (1000 * 60 * 60);
    
    // áŠ¨ 48 áˆ°á‹“á‰³á‰µ á‰ áˆ‹á‹­ áŠ«áˆˆáˆá‹, streak á‰°á‰‹áˆ­áŒ§áˆ
    return hoursElapsed > STREAK_BREAK_HOURS; 
}


window.updateDailyRewardModal = () => {
    const rewardGrid = document.getElementById('reward-grid');
    const claimButton = document.getElementById('daily-reward-claim-button');
    
    if (!currentUserDocData) return;

    // 1. á‹¨Streak áˆáŠ”á‰³áŠ• áˆ˜áˆá‰°áˆ½
    const { isReady, remainingMs } = checkDailyLimit('last_streak_claim_time');
    
    // âœ…âœ…âœ… === á‹¨áˆáŒ‚áŠ­ áˆ›áˆµá‰°áŠ«áŠ¨á‹« (Streak Break Logic) === âœ…âœ…âœ…
    const isStreakBroken = checkStreakBroken(currentUserDocData.last_streak_claim_time);
    
    let nextDayToClaim;
    if (isStreakBroken) {
        nextDayToClaim = 1; // á‰°á‰‹áˆ­áŒ§áˆá£ á‹ˆá‹° á‰€áŠ• 1 á‰°áˆ˜áˆˆáˆµ
    } else {
        nextDayToClaim = currentUserDocData.daily_streak || 1; // áŠ«áˆá‰°á‰‹áˆ¨áŒ  áŠ¨á‰†áˆ˜á‰ á‰µ á‹­á‰€áŒ¥áˆ (á‹ˆá‹­áˆ 1)
    }
    
    const daysAlreadyClaimed = (nextDayToClaim > 1 && !isStreakBroken) ? (nextDayToClaim - 1) : 0;
    // âœ…âœ…âœ… === áˆ›áˆµá‰°áŠ«áŠ¨á‹«á‹ áŠ áˆˆá‰€ === âœ…âœ…âœ…

    let rewardCardsHtml = '';

    dailyStreakRewards.forEach((reward, index) => {
        const dayNumber = index + 1;
        
        // âœ… á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆ áˆáŒ‚áŠ­
        const isClaimedToday = dayNumber <= daysAlreadyClaimed; 
        const isNextDay = dayNumber === nextDayToClaim;
        
        let cardClass = '';
        
        if (isClaimedToday) {
            cardClass = 'claimed';
        } else if (isNextDay && isReady) {
            cardClass = 'active-ready';
        }

        rewardCardsHtml += `
            <div class="reward-day-card ${cardClass}" id="reward-day-${dayNumber}">
                <p style="font-size: 10px; color: ${cardClass === 'claimed' ? 'var(--tg-hint)' : 'var(--tg-text)'}; margin: 0;">Day ${dayNumber}</p>
                <div class="reward-coin-icon">${(reward.coins / 1000).toFixed(0)}K</div> 
                <span>${reward.coins.toLocaleString()}</span> 
            </div>
        `;
    });
    
    rewardGrid.innerHTML = rewardCardsHtml;

    // 2. á‹¨Claim áŠ á‹áˆ«áˆ­áŠ• áˆ›á‹˜áˆ˜áŠ•
    if (isReady) {
        // áˆ½áˆáˆ›á‰± (index) áŠ¨ 0 áˆµáˆˆáˆšáŒ€áˆáˆ­ `nextDayToClaim - 1` áŠ¥áŠ•áŒ á‰€áˆ›áˆˆáŠ•
        const rewardAmount = dailyStreakRewards[nextDayToClaim - 1].coins;

        claimButton.disabled = false;
        claimButton.style.backgroundColor = 'var(--et-green)';
        claimButton.style.boxShadow = '0 4px 0 #388E3C';
        claimButton.innerText = `CLAIM DAY ${nextDayToClaim} (+${rewardAmount.toLocaleString()} ğŸ’°)`; 
        claimButton.onclick = () => window.claimDailyReward(nextDayToClaim, rewardAmount); 
    
    } else {
        claimButton.disabled = true;
        claimButton.style.backgroundColor = '#555';
        claimButton.style.boxShadow = '0 4px 0 #333';
        claimButton.onclick = null;
        claimButton.innerText = `Come back tomorrow (${formatTime(remainingMs)} left)`;
        
        // á‹¨áŒŠá‹œ á‰†áŒ£áˆªáŠ• á‰ á‹¨áˆ°áŠ¨áŠ•á‹± áŠ¥áŠ•á‹²á‹«á‹˜áˆáŠ• áˆ›á‹µáˆ¨áŒ
        if (timerIntervals['daily_streak_timer']) {
            clearInterval(timerIntervals['daily_streak_timer']);
        }
        timerIntervals['daily_streak_timer'] = setInterval(() => {
            const { isReady: checkAgain, remainingMs: remainingAgain } = checkDailyLimit('last_streak_claim_time');
            if(checkAgain) {
                window.updateDailyRewardModal(); // áˆ½áˆáˆ›á‰± á‹áŒáŒ áˆ²áˆ†áŠ• áˆá‹³áˆ‰áŠ• á‹«á‹˜áˆáŠ“áˆ
                clearInterval(timerIntervals['daily_streak_timer']);
                delete timerIntervals['daily_streak_timer'];
            } else {
                claimButton.innerText = `Come back tomorrow (${formatTime(remainingAgain)} left)`;
            }
        }, 1000);
    }
}

window.claimDailyReward = async (dayToClaim, coins) => { 
    
    // âœ…âœ…âœ… === á‹¨ Streak áˆ›áˆ¨áŒ‹áŒˆáŒ« (Validation) === âœ…âœ…âœ…
    const isStreakBroken = checkStreakBroken(currentUserDocData.last_streak_claim_time);
    
    let expectedDayToClaim;
    if (isStreakBroken) {
        expectedDayToClaim = 1; // á‰°á‰‹áˆ­áŒ§áˆá£ á‰€áŠ• 1áŠ• áˆ˜áŒ á‰ á‰…
    } else {
        expectedDayToClaim = currentUserDocData.daily_streak || 1; // áŠ«áˆá‰°á‰‹áˆ¨áŒ  áŠ¨á‰†áˆ˜á‰ á‰µ
    }
    
    // á‰°áŒ á‰ƒáˆšá‹ claim áˆˆáˆ›á‹µáˆ¨áŒ á‹¨áˆáŠ¨áˆ¨á‹ á‰€áŠ• áŠ¥áŠ“ áŠ¥áŠ› á‹¨áˆáŠ•áŒ á‰¥á‰€á‹ á‰€áŠ• á‹­á‹›áˆ˜á‹³áˆ‰?
    if (dayToClaim !== expectedDayToClaim) {
        WebApp.showAlert("âŒ á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• á‰€áŠ• áŠ¥á‹¨áŒ á‹¨á‰ áŠ á‹­á‹°áˆ‰áˆ! (Streak may have reset)");
        window.updateDailyRewardModal(); // UI áŠ¥áŠ•á‹²áˆµá‰°áŠ«áŠ¨áˆ
        return;
    }
    // âœ…âœ…âœ… === áˆ›áˆ¨áŒ‹áŒˆáŒ«á‹ áŠ áˆˆá‰€ === âœ…âœ…âœ…
    
    // á‹¨ streak á‰†áŒ áˆ«á‹ á‰ á‰€áŒ¥á‰³ á‹ˆá‹°áˆšá‰€áŒ¥áˆˆá‹ á‰€áŠ• á‹­á‹˜áˆ‹áˆ. 10 áŠ¨á‹°áˆ¨áˆ° á‹ˆá‹° 1 á‹­áˆ˜áˆˆáˆ³áˆ.
    const newStreakCount = dayToClaim >= dailyStreakRewards.length ? 1 : dayToClaim + 1;
    
    const extraUpdateData = {
        // áŠ á‹²áˆ± streak á‰áŒ¥áˆ­ (áŠ¨1 áŠ¥áˆµáŠ¨ 10)
        daily_streak: newStreakCount, 
        // á‹­áˆ… áŒŠá‹œ á‰†áŒ£áˆª áŠáŒˆ áŠ¥áŠ•á‹²áˆ°áˆ« á‹¨áˆšá‹«á‹°áˆ­áŒˆá‹ áŠá‹
        last_streak_claim_time: serverTimestamp(), 
    };
    
    // áŠ á‹áˆ«áˆ©áŠ• áŠ¥áŠ•á‹³á‹­áŒ«áŠ• áˆ›á‹µáˆ¨áŒ
    document.getElementById('daily-reward-claim-button').disabled = true;
    document.getElementById('daily-reward-claim-button').innerText = 'CLAIMED!';

    const success = await updateScore(coins, `Daily Streak Day ${dayToClaim}`, 'last_streak_claim_time', extraUpdateData); 

    if (success) {
        window.playSound('win'); // ğŸ›‘ á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
        // á‰ á‰°áˆ³áŠ« áˆáŠ”á‰³ áŠ¨á‰°áˆ°áŒ  á‰ áŠ‹áˆ‹ á‹¨áŠ áˆáŠ‘áŠ• á‹¨áˆá‹³áˆ áŠ¥á‹­á‰³ á‹ˆá‹²á‹«á‹áŠ‘ áˆ›á‹˜áˆ˜áŠ•
        if (timerIntervals['daily_streak_timer']) {
             clearInterval(timerIntervals['daily_streak_timer']);
             delete timerIntervals['daily_streak_timer'];
        }
        // Firebase á‹³á‰³á‹ á‰  onSnapshot áˆµáˆˆáˆšá‹˜áˆáŠ•, á‰µáŠ•áˆ½ á‰†á‹­á‰¶ updateDailyRewardModal áˆ˜áŒ¥áˆ«á‰µ
        setTimeout(window.updateDailyRewardModal, 1000); 
        renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
    }
}


        // ======================================================================
        //                          DAILY STREAK MODAL CODE áˆ˜áŒ¨áˆ¨áˆ»
        // ======================================================================
        // ======================================================================
        //                          LUCKY SLOT GAME CODE ğŸ›‘ UPDATED SECTION
        // ======================================================================
        
        // ğŸ›‘ UPDATED (Problem #1 Fixed)
        window.updateSlotGameUI = () => {
             const spinBtn = document.getElementById('spin-btn');
             const spinsLeftDisplay = document.getElementById('spins-left');
             const messageEl = document.getElementById('game-message');
             const resetTimerEl = document.getElementById('reset-timer');
             const resetContainer = document.getElementById('reset-timer-container');
             
             // âœ… á‹¨á‰†áŒ£áˆª á‰áˆá (timer key) áŠ¨áˆŒáˆá‰½ á‰†áŒ£áˆªá‹á‰½ áŒ‹áˆ­ áŠ¥áŠ•á‹³á‹­áŒ‹áŒ­
             const timerKey = 'slot_reset_timer';

             spinsLeftDisplay.innerText = currentSpinsLeft;
             
             const { isReady: resetReady, remainingMs: resetRemainingMs } = checkDailyLimit(SLOTS_COOLDOWN_FIELD);
             
             if (currentSpinsLeft > 0) {
                 spinBtn.disabled = false;
                 spinBtn.innerText = "áŠ¥áˆ½áŠ­áˆ­áŠ­áˆªá‰µ áˆˆáˆ˜áŒ€áˆ˜áˆ­ á‹­áŒ«áŠ‘ \n SPIN";
                 spinBtn.onclick = window.spinSlotMachine;
                 resetContainer.style.display = 'none';
                 messageEl.innerText = "Spin áˆˆáˆ›á‹µáˆ¨áŒ á‹­áŒ«áŠ‘á¢";

                 // âœ… áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹ áŠ¥á‹¨áˆ°áˆ« áŠ¨áˆ†áŠ áˆ›á‰†áˆ (spin áˆµáˆ‹áŒˆáŠ˜)
                 if (timerIntervals[timerKey]) {
                     clearInterval(timerIntervals[timerKey]);
                     delete timerIntervals[timerKey];
                 }
             } else if (resetReady) {
                 spinBtn.disabled = false;
                 spinBtn.innerText = "RESET & SPIN";
                 spinBtn.onclick = () => window.resetSlotGameAndSpin(true);
                 resetContainer.style.display = 'block';
                 resetTimerEl.innerText = "Ready to Reset!";
                 messageEl.innerText = "Spin áŠ áˆá‰‹áˆ! áŠ á‹²áˆµ áˆ™áŠ¨áˆ« áˆˆáˆ˜áŒ€áˆ˜áˆ­ RESET & SPIN á‹­áŒ«áŠ‘á¢";

                 // âœ… áˆ°á‹“á‰µ á‰†áŒ£áˆªá‹ áŠ¥á‹¨áˆ°áˆ« áŠ¨áˆ†áŠ áˆ›á‰†áˆ (á‹áŒáŒ áˆµáˆˆáˆ†áŠ)
                 if (timerIntervals[timerKey]) {
                     clearInterval(timerIntervals[timerKey]);
                     delete timerIntervals[timerKey];
                 }
             } else {
                 spinBtn.disabled = true;
                 spinBtn.innerText = "SPIN (No Spins Left)";
                 spinBtn.onclick = null;
                 resetContainer.style.display = 'block';
                 messageEl.innerText = "Spin áŠ áˆá‰‹áˆá¢ áŒŠá‹œ áŠ¥áˆµáŠªáŒ áŠ“á‰€á‰… á‹­áŒ á‰¥á‰á¢";
                 
                 // ğŸ›‘ğŸ›‘ğŸ›‘ === FIX #1 ADDED === ğŸ›‘ğŸ›‘ğŸ›‘
                 // áˆ°á‹“á‰± áŠ¥áŠ•á‹²á‰†áŒ¥áˆ­ áˆ›á‹µáˆ¨áŒ
                 resetTimerEl.innerText = `Reset in: ${formatTime(resetRemainingMs)}`; 
                 
                 if (!timerIntervals[timerKey]) { // á‰†áŒ£áˆªá‹ áŠ áˆµá‰€á‹µáˆ áŠ«áˆá‰°áŒ€áˆ˜áˆ¨ á‰¥á‰»
                     timerIntervals[timerKey] = setInterval(() => {
                         const { isReady: checkAgain, remainingMs: remainingAgain } = checkDailyLimit(SLOTS_COOLDOWN_FIELD);
                         if(checkAgain) {
                             window.updateSlotGameUI(); // áŒŠá‹œá‹ áˆ²á‹«áˆá‰… UIáŠ• á‹«á‹˜áˆáŠ“áˆ
                             clearInterval(timerIntervals[timerKey]);
                             delete timerIntervals[timerKey];
                         } else {
                             resetTimerEl.innerText = `Reset in: ${formatTime(remainingAgain)}`;
                         }
                     }, 1000);
                 }
                 // ğŸ›‘ğŸ›‘ğŸ›‘ === END OF FIX === ğŸ›‘ğŸ›‘ğŸ›‘
             }
        }
        
        // ğŸ›‘ UPDATED (á‹­áˆ… á‰°áŒá‰£áˆ­ á‰µáŠ­áŠ­áˆ áŠá‰ áˆ­)
        window.resetSlotGameAndSpin = async (startSpin = false) => {
            if (currentSpinsLeft > 0) return; // á‹¨áˆšáˆ°áˆ«á‹ á‹œáˆ® áˆ²áˆ†áŠ• á‰¥á‰» áŠá‹
            
            const userRef = doc(db, "users", currentFirebaseUserId); 
            
            const updateData = {
                slot_spins_left: SLOTS_MAX_SPINS,
                last_slot_reset_time: serverTimestamp(),
            };
            
            try {
                await updateDoc(userRef, updateData);
                currentSpinsLeft = SLOTS_MAX_SPINS; // á‹ˆá‹²á‹«á‹áŠ‘ UIáŠ• áˆˆáˆ›á‹˜áˆ˜áŠ•
                
                if (startSpin) {
                    WebApp.showAlert("âœ… Slot Game á‹³áŒáˆ á‰°áŒ€áˆáˆ¯áˆá¢ áŠ áˆáŠ• áˆµá’áŠ• áˆ›á‹µáˆ¨áŒ á‹­á‰½áˆ‹áˆ‰á¢");
                    await window.spinSlotMachine(); 
                } else {
                    WebApp.showAlert("âœ… Slot Game á‹³áŒáˆ á‰°áŒ€áˆáˆ¯áˆ! 10 Spin áŠ áŒáŠá‰°á‹‹áˆá¢");
                }
                
                window.updateSlotGameUI(); 
                return true;
            } catch (error) {
                WebApp.showAlert("âŒ Slot GameáŠ• á‹³áŒáˆ á‰ áˆ›áˆµáŒ€áˆ˜áˆ­ áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ áˆ¨: " + error.message);
                console.error("Error resetting Slot Game:", error);
                return false;
            }
        }
        
        // ğŸ›‘ UPDATED (Problem #2 Fixed)
        window.spinSlotMachine = async () => {
            if (currentSpinsLeft <= 0) {
                 WebApp.showAlert("âŒ áˆáŠ•áˆ á‰€áˆª Spin á‹¨áˆˆá‹á‰µáˆá¢");
                 window.updateSlotGameUI(); 
                 return;
            }
            
            window.playSound('spin'); 
            
            const spinBtn = document.getElementById('spin-btn');
            const slots = [
                document.getElementById('slot-1'),
                document.getElementById('slot-2'),
                document.getElementById('slot-3')
            ];
            
            spinBtn.disabled = true;
            spinBtn.innerText = "SPINNING...";
            
            // ... (á‹¨áŠ áŠ’áˆœáˆ½áŠ• áŠ¥áŠ“ á‹¨á‹áŒ¤á‰µ áˆáŒ‚áŠ­áˆ… á‰ áˆ™áˆ‰ áŠ¥á‹šáˆ… áŒ‹áˆ­ - áˆáˆ‰áˆ á‰µáŠ­áŠ­áˆ áŠá‹) ...
            // 1. á‹¨á‹˜áˆá‰€á‹° á‹áŒ¤á‰¶á‰½áŠ• áˆ›áˆ˜áŠ•áŒ¨á‰µ
            const isJackpotWinner = Math.random() < 0.08; 
            const finalPrizes = [];
            // ... (á‰€áˆªá‹ á‹¨á‹áŒ¤á‰µ áˆáŒ‚áŠ­) ...
            if (isJackpotWinner) {
                for(let i=0; i<3; i++) finalPrizes.push(slotItems[0]);
            } else {
                for(let i=0; i<3; i++) {
                    const randomIndex = Math.floor(Math.random() * slotItems.length);
                    finalPrizes.push(slotItems[randomIndex]);
                }
            }

            // 2. áŠ áŠ’áˆœáˆ½áŠ• áˆ˜áŒ€áˆ˜áˆ­ áŠ¥áŠ“ á‹áŒ¤á‰±áŠ• áˆ›áˆ³á‹¨á‰µ
            let animations = [];
            // ... (á‰€áˆªá‹ á‹¨áŠ áŠ’áˆœáˆ½áŠ• áˆáŒ‚áŠ­) ...
            slots.forEach((slot, index) => {
                 const randomStopIndex = Math.floor(Math.random() * 20) + 10; 
                 const finalPosition = 360 * randomStopIndex + index * 120 + 360; 
                 
                 slot.classList.add('spinning-slot'); 
                 slot.style.transition = `transform ${2 + index * 0.5}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                 slot.style.transform = `translateY(-${finalPosition}px)`;

                 animations.push(new Promise(resolve => {
                    setTimeout(() => {
                         slot.style.transition = 'none'; 
                         slot.style.transform = `translateY(0px)`; 
                         slot.classList.remove('spinning-slot');
                         slot.innerHTML = `<div class="slot-content">${finalPrizes[index]}</div>`;
                         resolve();
                    }, (2.5 + index * 0.5) * 1000); 
                 }));
            });
            
            await Promise.all(animations); 
            
             // 3. á‹áŒ¤á‰±áŠ• áˆ›áˆµáˆ‹á‰µ
             // ... (á‰€áˆªá‹ á‹¨á‹áŒ¤á‰µ áˆ›áˆµáˆ‹á‰µ áˆáŒ‚áŠ­ - áˆáˆ‰áˆ á‰µáŠ­áŠ­áˆ áŠá‹) ...
             let message = "";
             let totalCoins = 0; 

             if (finalPrizes[0] === 'ğŸ’' && finalPrizes[1] === 'ğŸ’' && finalPrizes[2] === 'ğŸ’') {
                 totalCoins = COIN_REWARD; 
                 message = `ğŸ‰ JACKPOT! +${totalCoins.toLocaleString()} coin áŠ áˆ¸áŠ•áˆá‹‹áˆ!`; 
                 window.playSound('win'); 
             } else if (finalPrizes[0] === finalPrizes[1] && finalPrizes[1] === finalPrizes[2]) {
                totalCoins = 500;
                message = `ğŸ¥³ áˆ¶áˆµá‰µ á‰°áˆ˜áˆ³áˆ³á‹­! +${totalCoins} coin áŠ áˆ¸áŠ•áˆá‹‹áˆá¢`; 
             } else if (finalPrizes.filter(item => item === 'ğŸ’').length >= 2) {
                 totalCoins = 100;
                 message = `á‰µáŠ•áˆ½ á‰€áˆ¨! +${totalCoins} coin áŠ áˆ¸áŠ•áˆá‹‹áˆá¢`; 
             } else {
                 totalCoins = 0;
                 message = `ğŸ˜¢ áŠ áˆá‰°áˆ³áŠ«áˆ! 0 coiná¢`; 
                 window.playSound('fail'); 
             }
             
             document.getElementById('game-message').innerText = message;
             
             // 4. Firebase áˆ‹á‹­ áˆ›á‹˜áˆ˜áŠ•
             currentSpinsLeft--;
             
             const extraUpdateData = {
                 slot_spins_left: currentSpinsLeft,
             };
             
             if (totalCoins > 0) {
                 await updateScore(totalCoins, 'Lucky Slot Game', null, extraUpdateData);
             } else {
                 const userRef = doc(db, "users", currentFirebaseUserId); 
                 await updateDoc(userRef, extraUpdateData);
             }
             
             // 5. UIáŠ• áˆ›á‹˜áˆ˜áŠ•
             window.updateSlotGameUI(); 
             
             // 6. á‰†áŒ£áˆªá‹áŠ• áˆ›á‹˜áˆ˜áŠ•
             // ğŸ›‘ğŸ›‘ğŸ›‘ === FIX #2 REMOVED === ğŸ›‘ğŸ›‘ğŸ›‘
             // á‹­áˆ… áˆ˜áˆµáˆ˜áˆ­ á‰°á‹ˆáŒá‹·áˆ!
             // window.startCooldownTimer(SLOTS_COOLDOWN_FIELD, 'reset-timer', 'spin-btn');
             // ğŸ›‘ğŸ›‘ğŸ›‘ === END OF FIX === ğŸ›‘ğŸ›‘ğŸ›‘
        }


        // ======================================================================
        //                          DAILY SPIN GAME CODE
        // ======================================================================
                // âœ… áŠ á‹²áˆ± (á‰µáŠ­áŠ­áˆˆáŠ›á‹) áŠ®á‹µ á‹­áˆ„ áŠá‹á¡
        const spinPrizes = [
            { coins: 1000, segmentIndex: 0, text: "1000 coin" }, // Segment 0 (0deg)
            { coins: 500, segmentIndex: 1, text: "500 coin" },  // Segment 1 (36deg)
            { coins: 200, segmentIndex: 2, text: "200 coin" },  // Segment 2 (72deg)
            { coins: 100, segmentIndex: 3, text: "100 coin" },  // Segment 3 (108deg)
            { coins: 50, segmentIndex: 4, text: "50 coin" },   // Segment 4 (144deg)
            { coins: 20, segmentIndex: 5, text: "20 coin" },   // Segment 5 (180deg)
            { coins: 10, segmentIndex: 6, text: "10 coin" },   // Segment 6 (216deg)
            { coins: 5, segmentIndex: 7, text: "5 coin" },    // Segment 7 (252deg)
            { coins: 0, segmentIndex: 8, text: "0 coin" },     // Segment 8 (288deg)
            { coins: 10, segmentIndex: 9, text: "10 coin" }    // Segment 9 (324deg)
        ];

        
        const segmentAngle = 360 / spinPrizes.length;

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.spinTheWheel = async () => {
            const timestampField = 'last_spin_time';
            const actionButton = document.getElementById('daily-spin-action');

            const { isReady } = checkDailyLimit(timestampField);
            if (!isReady) {
                WebApp.showAlert(`âŒ á‹•áˆˆá‰³á‹Š áˆ½áŠ­áˆ­áŠ­áˆ­ (Daily Spin) áˆˆ 24 áˆ°á‹“á‰µ á‰¥á‰» á‹­áˆ°áŒ£áˆá¢`);
                return;
            }

            actionButton.disabled = true;
            window.playSound('spin'); // ğŸ›‘ á‹¨ Spin á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­

            const randomIndex = Math.floor(Math.random() * spinPrizes.length);
            const winningPrize = spinPrizes[randomIndex];

            const baseRotation = 360 * 10; 
            const targetRotation = baseRotation - (randomIndex * segmentAngle);


            const wheel = document.getElementById('spin-wheel');
            wheel.style.transition = 'transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)';
            wheel.style.transform = `rotate(${targetRotation}deg)`;

            await new Promise(resolve => setTimeout(resolve, 4000));

            if (await updateScore(winningPrize.coins, 'Daily Spin', timestampField)) { 
                WebApp.showAlert(`ğŸ¥³ áŠ¥áŠ•áŠ³áŠ• á‹°áˆµ áŠ áˆˆá‹á‰µ! ${winningPrize.coins.toLocaleString()} coin áŠ áˆ¸áŠ•áˆá‹‹áˆ!`); 
                window.playSound('win'); // ğŸ›‘ á‹¨ Win á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
            }
            
            startCooldownTimer(timestampField, 'daily-spin-timer', 'daily-spin-action');
            renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
        };

        // ======================================================================
        //                          MYSTERY BOX GAME CODE
        // ======================================================================
        const mysteryPrizes = [100, 250, 500]; 
        let hasPlayedMysteryBox = false;
        let correctBoxIndex = -1;

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.resetMysteryBox = (showSuccessMessage = true) => {
            const actionButton = document.getElementById('mystery-box-action');
            const messageEl = document.getElementById('box-message');
            const boxes = [document.getElementById('box-1'), document.getElementById('box-2'), document.getElementById('box-3')];
            
            boxes.forEach(box => {
                box.innerText = '?';
                box.classList.remove('opened', 'missed');
                box.style.pointerEvents = 'auto'; 
                box.style.backgroundColor = 'var(--et-red)';
                // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: playMysteryBox()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
                box.onclick = () => window.playMysteryBox(parseInt(box.id.split('-')[1])); 
                // á‹¨3D áŒ¥áˆ‹á‹áŠ• á‹­áˆ˜áˆáˆ±
                box.style.boxShadow = '0 8px 0 #A83232';
                box.style.transform = 'translateY(0)';
            });
            
            actionButton.innerText = 'áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©';
            actionButton.disabled = false;
            actionButton.style.display = 'none'; 
            messageEl.innerText = 'áˆ³áŒ¥áŠ• á‹­áˆáˆ¨áŒ¡!';
            
            hasPlayedMysteryBox = false;
            correctBoxIndex = Math.floor(Math.random() * 3) + 1; 
            
            const { isReady } = checkDailyLimit('last_mystery_time');
            if (!isReady) {
                 boxes.forEach(box => box.style.pointerEvents = 'none');
                 messageEl.innerText = 'á‹›áˆ¬ á‰°áŒ«á‹á‰°á‹‹áˆá¢ áŠáŒˆ á‹­áˆáŠ­áˆ©á¢';
                 actionButton.style.display = 'block'; 
                 actionButton.innerText = 'á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ';
                 // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: showMainPage()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
                 actionButton.onclick = window.showMainPage; 
            }
            
            if (showSuccessMessage) WebApp.showAlert('áŒ¨á‹‹á‰³á‹ á‹³áŒáˆ á‰°áŒ€áˆáˆ¯áˆ!');
        }

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.playMysteryBox = async (selectedBoxIndex) => {
            const timestampField = 'last_mystery_time';
            const messageEl = document.getElementById('box-message');
            const boxes = [document.getElementById('box-1'), document.getElementById('box-2'), document.getElementById('box-3')];
            const actionButton = document.getElementById('mystery-box-action');

            if (hasPlayedMysteryBox) return; 

            const { isReady } = checkDailyLimit(timestampField);
            if (!isReady) {
                WebApp.showAlert(`âŒ áˆšáˆµáŒ¥áˆ«á‹Š áˆ£áŒ¥áŠ• (Mystery Box) áˆˆ 24 áˆ°á‹“á‰µ á‰¥á‰» á‹­áˆ°áŒ£áˆá¢`);
                return;
            }

            hasPlayedMysteryBox = true;
            boxes.forEach(box => box.style.pointerEvents = 'none'); 

            let coinsWon = 0; 
            const winningPrize = mysteryPrizes[Math.floor(Math.random() * mysteryPrizes.length)];
            
            boxes.forEach((box, index) => {
                const boxNum = index + 1;
                if (boxNum === correctBoxIndex) {
                    box.innerText = `+${winningPrize}`;
                    box.classList.add('opened');
                    box.style.backgroundColor = 'var(--et-green)';
                    box.style.boxShadow = '0 8px 0 #388E3C';
                    if (boxNum === selectedBoxIndex) {
                        coinsWon = winningPrize; 
                        // á‹¨áˆ˜áˆ¨áŒ¥áŠá‹áŠ• áˆ³áŒ¥áŠ• á‰µáŠ•áˆ½ á‹ˆá‹°áˆ‹á‹­ áŠ¥áŠ•á‹²áŠ•á‰€áˆ³á‰€áˆµ áŠ¥áŠ“á‹µáˆ­áŒ
                        box.style.transform = 'translateY(-5px)'; 
                    }
                } else {
                    box.innerText = 'âŒ';
                    box.classList.add('missed');
                    box.style.backgroundColor = 'var(--tg-hint)';
                    box.style.boxShadow = '0 8px 0 #333';
                }
            });

            if (selectedBoxIndex === correctBoxIndex) {
                messageEl.innerText = `ğŸ¥³ áŠ áˆ¸áŠ•áˆá‹‹áˆ! ${winningPrize.toLocaleString()} coin!`; // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin
                window.playSound('win'); // ğŸ›‘ á‹¨ Win á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
            } else {
                messageEl.innerText = `ğŸ˜¢ áŠ áˆá‰°áˆ³áŠ«áˆá¢ á‰µáŠ­áŠ­áˆˆáŠ›á‹ áˆ³áŒ¥áŠ• á‰áŒ¥áˆ­ ${correctBoxIndex} áŠá‰ áˆ­á¢`;
                window.playSound('fail'); // ğŸ›‘ á‹¨ Fail á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
            }
            
            if (coinsWon > 0) { 
                await updateScore(coinsWon, 'Mystery Box Game', timestampField); // ğŸ›‘ pointsWon á‹ˆá‹° coinsWon
            } else {
                 WebApp.showAlert('âŒ áˆáŠ•áˆ coin áŠ áˆ‹áŒˆáŠ™áˆá¢ áŠáŒˆ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢'); // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin
            }
            
            startCooldownTimer(timestampField, 'mystery-box-timer', 'mystery-box-action');
            actionButton.style.display = 'block'; 
            actionButton.innerText = 'á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ';
            // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: showMainPage()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
            actionButton.onclick = window.showMainPage;
            renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
        }

        // ======================================================================
        //                           REFLEX GAME CODE 
        // ======================================================================
        let timeoutID = null;
        let startTime = 0;
        let isWaitingForClick = false;

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.resetReflexGame = (showSuccessMessage = true) => {
            clearTimeout(timeoutID);
            isWaitingForClick = false;
            isReflexGameRunning = false; 
            document.getElementById('reflex-button').style.display = 'none';
            document.getElementById('reflex-message').innerText = 'áˆˆáˆ˜áŒ€áˆ˜áˆ­ áŠ¨á‰³á‰½ á‹«áˆˆá‹áŠ• á‰áˆá á‹­áŒ«áŠ‘á¢';
            document.getElementById('reflex-result').innerText = '';
            document.getElementById('reflex-game-action').innerText = 'áŒ¨á‹‹á‰³á‹áŠ• áŒ€áˆáˆ­';
            document.getElementById('reflex-game-action').disabled = false;
            // ?? á‹¨á‰°áˆ»áˆ»áˆˆá‹: handleReflexTooEarlyClick()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
            document.getElementById('reflex-play-area').onclick = window.handleReflexTooEarlyClick; 
            
            const { isReady } = checkDailyLimit('last_reflex_time');
            if (!isReady) {
                 document.getElementById('reflex-game-action').classList.add('cooldown');
                 document.getElementById('reflex-game-action').disabled = true;
                 document.getElementById('reflex-message').innerText = 'á‹›áˆ¬ á‰°áŒ«á‹á‰°á‹‹áˆá¢ áŠáŒˆ á‹­áˆáŠ­áˆ©á¢';
            } else {
                 document.getElementById('reflex-game-action').classList.remove('cooldown');
            }
            
            if (showSuccessMessage) WebApp.showAlert('áŒ¨á‹‹á‰³á‹ á‹³áŒáˆ á‰°áŒ€áˆáˆ¯áˆ!');
        }

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.handleReflexTooEarlyClick = () => {
             if (isReflexGameRunning && !isWaitingForClick) {
                 clearTimeout(timeoutID);
                 // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: handleReflexFailure()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
                 window.handleReflexFailure("âŒ á‰ áŒ£áˆ á‰€á‹µáˆ˜á‹‹áˆ! áŠ áˆ¨áŠ•áŒ“á‹´ áŠ¥áˆµáŠªáˆ†áŠ• áˆ˜áŒ á‰ á‰… áŠá‰ áˆ¨á‰¥á‹á¢");
                 window.playSound('fail'); // ğŸ›‘ á‹¨ Fail á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
             }
        }
        
        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.startReflexGame = () => {
            const timestampField = 'last_reflex_time';
            const actionButton = document.getElementById('reflex-game-action');

            const { isReady } = checkDailyLimit(timestampField);
            if (!isReady) {
                WebApp.showAlert(`âŒ á‹¨ááŒ¥áŠá‰µ áŒ¨á‹‹á‰³ (Reflex Game) áˆˆ 24 áˆ°á‹“á‰µ á‰¥á‰» á‹­áˆ°áŒ£áˆá¢`);
                return;
            }
            
            actionButton.disabled = true;
            actionButton.innerText = 'á‰°áŒ áŠ“á‰‹áˆ...';
            isReflexGameRunning = true; 
            
            document.getElementById('reflex-message').innerText = 'á‰€á‹­ áŠ¥áˆµáŠªáˆ†áŠ• á‹­áŒ á‰¥á‰...';
            document.getElementById('reflex-result').innerText = '';
            // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: handleReflexTooEarlyClick()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
            document.getElementById('reflex-play-area').onclick = window.handleReflexTooEarlyClick;

            const delay = Math.random() * 3000 + 1000; 
            
            timeoutID = setTimeout(() => {
                document.getElementById('reflex-message').style.display = 'none';
                document.getElementById('reflex-button').style.display = 'flex';
                document.getElementById('reflex-button').style.backgroundColor = 'var(--et-green)'; 
                document.getElementById('reflex-button').innerText = 'TAP ME!';
                isWaitingForClick = true;
                startTime = performance.now();
                
                timeoutID = setTimeout(() => {
                    // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: stopReflexGame()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
                    window.stopReflexGame(null, true); 
                }, 3000); 
                
            }, delay);
        };
        
        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.handleReflexFailure = (message) => {
            clearTimeout(timeoutID);
            isWaitingForClick = false;
            isReflexGameRunning = false; 
            
            document.getElementById('reflex-message').innerText = message;
            document.getElementById('reflex-message').style.display = 'block';
            document.getElementById('reflex-button').style.display = 'none';
            document.getElementById('reflex-result').innerText = '0 coin'; 
            
            document.getElementById('reflex-game-action').innerText = 'áŒ¨á‹‹á‰³á‹áŠ• áŒ€áˆáˆ­';
            document.getElementById('reflex-game-action').disabled = false;
            // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: handleReflexTooEarlyClick()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
            document.getElementById('reflex-play-area').onclick = window.handleReflexTooEarlyClick; 
        }

        // ğŸ›‘ window. á‰°áŒ¨áˆ˜áˆ¨
        window.stopReflexGame = async (event, isTimeout = false) => {
            if (event && event.type === 'click') {
                event.stopPropagation(); 
            }

            if (!isWaitingForClick && !isTimeout) return;
            
            clearTimeout(timeoutID);
            const endTime = performance.now();
            const reactionTime = Math.round(endTime - startTime);
            
            isWaitingForClick = false;
            isReflexGameRunning = false; 
            
            document.getElementById('reflex-button').style.display = 'none';
            document.getElementById('reflex-message').style.display = 'block';
            document.getElementById('reflex-message').innerText = 'áŒ¨á‹‹á‰³á‹ á‰°áŒ áŠ“á‰‹áˆ!';
            document.getElementById('reflex-play-area').onclick = null; 


            let coins = 0; 
            
            if (isTimeout) {
                document.getElementById('reflex-result').innerText = `âŒ áŒŠá‹œá‹ áŠ áˆááˆ! 0 coin`; 
                window.playSound('fail'); // ğŸ›‘ á‹¨ Fail á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
            } else {
                window.playSound('click'); // ğŸ›‘ á‹¨ Click á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
                if (reactionTime < 200) {
                    coins = 500; 
                } else if (reactionTime < 300) {
                    coins = 200;
                } else if (reactionTime < 500) {
                    coins = 100;
                } else {
                    coins = 50;
                }
            
                document.getElementById('reflex-result').innerText = `ááŒ¥áŠá‰µá‹: ${reactionTime}ms. áˆ½áˆáˆ›á‰µ: +${coins.toLocaleString()} coin!`; // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin

                if (await updateScore(coins, 'Reflex Game', 'last_reflex_time')) { 
                    WebApp.showAlert(`ğŸ¥³ áŠ¥áŠ•áŠ³áŠ• á‹°áˆµ áŠ áˆˆá‹á‰µ! ${coins.toLocaleString()} coin áŠ áˆ¸áŠ•áˆá‹‹áˆ!`); 
                    window.playSound('win'); // ğŸ›‘ á‹¨ Win á‹µáˆáŒ½ áˆ˜áŒ¨áˆ˜áˆ­
                }
            }
            
            startCooldownTimer('last_reflex_time', 'reflex-game-timer', 'reflex-game-action');
            document.getElementById('reflex-game-action').innerText = 'á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ';
            // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: showMainPage()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
            document.getElementById('reflex-game-action').onclick = window.showMainPage;
            document.getElementById('reflex-game-action').disabled = false;
            
            setTimeout(() => {
                // ğŸ›‘ á‹¨á‰°áˆ»áˆ»áˆˆá‹: handleReflexTooEarlyClick()áŠ• á‰ á‰€áŒ¥á‰³ áŒ áˆ­á‰·áˆ
                document.getElementById('reflex-play-area').onclick = window.handleReflexTooEarlyClick;
            }, 100); 
            renderPageContent(); // coináŠ• áˆˆáˆ›áˆ»áˆ»áˆ
        }

        // ======================================================================
        //                          SCRATCH CARD GAME CODE ğŸ›‘ áŠ á‹²áˆµ á‹¨á‰°áŒ¨áˆ˜áˆ¨
        // ======================================================================
        
        let scratchCanvas, scratchCtx, isScratching = false;
        let isScratchGameActive = false; // áŒ¨á‹‹á‰³á‹ áŠ áŠ•á‹´ á‰¥á‰» áˆ½áˆáˆ›á‰µ áŠ¥áŠ•á‹²áˆ°áŒ¥
        let scratchPrizeAmount = 0;
        const SCRATCH_PRIZES = [100, 150, 200, 300, 500]; // áˆŠáŒˆáŠ™ á‹¨áˆšá‰½áˆ‰ áˆ½áˆáˆ›á‰¶á‰½

        // 1. á‹¨ Canvas áˆ˜áˆá‰…áˆá‰‚á‹« áˆ˜á‰†áŒ£áŒ áˆªá‹«
        function getScratchCoords(e) {
            const rect = scratchCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function startScratch(e) {
            if (!isScratchGameActive) return;
            isScratching = true;
            scratch(e);
        }

        function stopScratch() {
            if (!isScratchGameActive) return;
            isScratching = false;
            // áˆ˜áˆá‰…áˆá‰… áˆ²á‰†áˆ áˆáŠ• á‹«áˆ…áˆ áŠ¥áŠ•á‹°á‰°áˆá‰€áˆá‰€ á‰¼áŠ­ áˆ›á‹µáˆ¨áŒ
            checkScratchPercentage();
        }

        function scratch(e) {
            if (!isScratching || !isScratchGameActive) return;
            e.preventDefault(); // áŒˆáŒ¹ áŠ¥áŠ•á‹³á‹­áˆ½áŠ¨áˆ¨áŠ¨áˆ­ (scroll) á‹«á‹°áˆ­áŒ‹áˆ

            const { x, y } = getScratchCoords(e);
            
            // "destination-out" áˆ›áˆˆá‰µ áŠ á‹²áˆµ áˆµáŠ¥áˆ áˆ²áˆ³áˆ áŠ áˆ®áŒŒá‹áŠ• á‹«áŒ á‹á‹‹áˆ (á‹­áˆá‰…áá‰€á‹‹áˆ)
            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 20, 0, Math.PI * 2, false); // 20px áˆ«á‹²á‹¨áˆµ á‹«áˆˆá‹ áŠ­á‰¥
            scratchCtx.fill();
        }

        // 2. áˆáŠ• á‹«áˆ…áˆ áŠ¥áŠ•á‹°á‰°áˆá‰€áˆá‰€ áˆ›á‹ˆá‰…
        function checkScratchPercentage() {
            if (!isScratchGameActive) return; // áŠ áˆµá‰€á‹µáˆ áŠ¨á‰°áŒ áŠ“á‰€á‰€ á‹­á‰°á‹á‰µ

            const imageData = scratchCtx.getImageData(0, 0, scratchCanvas.width, scratchCanvas.height);
            const data = imageData.data;
            let transparentPixels = 0;

            // áˆáˆ‰áŠ•áˆ á’áŠ­áˆ°áˆá‰½ áˆ˜á‰áŒ áˆ­ á‹á‹µ áˆµáˆˆáˆ†áŠá£ á‰ á‹¨ 32áŠ› á’áŠ­áˆ°áˆ áŠ¥áŠ•á‰†áŒ¥áˆ«áˆˆáŠ•
            for (let i = 0; i < data.length; i += 32) {
                // data[i+3] á‹¨á’áŠ­áˆ°áˆ‰áŠ• Alpha (transparency) á‹­á‹­á‹›áˆ
                if (data[i + 3] === 0) {
                    transparentPixels++;
                }
            }

            const totalPixels = (data.length / 32);
            const percentage = (transparentPixels / totalPixels) * 100;

            // 60% á‰ áˆ‹á‹­ áŠ¨á‰°áˆá‰€áˆá‰€ áˆ½áˆáˆ›á‰±áŠ• á‹­áˆµáŒ¡
            if (percentage > 60) {
                revealScratchPrize();
            }
        }

        // 3. áˆ½áˆáˆ›á‰±áŠ• áˆ˜áˆµáŒ á‰µ
        async function revealScratchPrize() {
            if (!isScratchGameActive) return; // á‹µáˆ­á‰¥ áˆ½áˆáˆ›á‰µ áŠ¥áŠ•á‹³á‹­áˆ°áŒ¥
            
            isScratchGameActive = false; // áŒ¨á‹‹á‰³á‹áŠ• á‹«á‰áˆ™
            window.playSound('win'); // ğŸ›‘ á‹¨á‹µáˆ á‹µáˆáŒ½

            // áˆ¸áˆ«á‹áŠ• (canvas) á‰€áˆµ á‰¥áˆ áŠ¥áŠ•á‹²áŒ á‹ áˆ›á‹µáˆ¨áŒ
            scratchCanvas.style.transition = 'opacity 0.5s ease';
            scratchCanvas.style.opacity = '0';
            
            document.getElementById('scratch-result-message').innerText = `ğŸ‰ +${scratchPrizeAmount.toLocaleString()} coin áŠ áˆ¸áŠ•áˆá‹‹áˆ!`;

            // áˆ½áˆáˆ›á‰±áŠ• áŠ¥áŠ“ á‹¨áŒŠá‹œ áˆ›áˆ…á‰°áˆ™áŠ• (timestamp) á‹ˆá‹° Firebase áˆ˜áˆ‹áŠ­
            // ğŸ›‘ áˆ›áˆµá‰°áŠ«áŠ¨á‹«: "last_scratch_time" á‹¨áˆšáˆˆá‹áŠ• á‰µáŠ­áŠ­áˆˆáŠ› á‹¨ cooldown field áŠ¥áŠ•áŒ á‰€áˆ›áˆˆáŠ•
            const success = await updateScore(scratchPrizeAmount, 'Scratch Card Game', 'last_scratch_time');
            
            if (success) {
                // UI áˆ›á‹˜áˆ˜áŠ•
                startCooldownTimer('last_scratch_time', 'scratch-card-timer', 'scratch-card-action');
                renderPageContent(); // áŠ áŒ á‰ƒáˆ‹á‹­ áŠáŒ¥á‰¥áŠ• á‹«á‹˜áˆáŠ“áˆ
                
                const actionButton = document.getElementById('scratch-card-action');
                actionButton.innerText = 'á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ';
                actionButton.style.display = 'block';
                actionButton.disabled = false;
                actionButton.onclick = window.showMainPage; // á‰°áŒá‰£áˆ©áŠ• áˆ˜á‰€á‹¨áˆ­
            } else {
                document.getElementById('scratch-result-message').innerText = 'áˆ½áˆáˆ›á‰µ á‰ áˆ˜áˆµáŒ á‰µ áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ¥áˆ¯áˆá¢';
            }
        }


        // 4. á‹¨ Scratch Card áŒ¨á‹‹á‰³ á‹‹áŠ“ á‰°áŒá‰£áˆ­ (Initializer)
        // á‹­áˆ„ á‰°áŒá‰£áˆ­ áŒˆáŒ¹ áˆ²áŠ¨áˆá‰µ á‹ˆá‹­áˆ "Reset" áˆ²áŒ«áŠ• á‹­áŒ áˆ«áˆ
        window.initScratchCard = (isReset = false) => {
            const timestampField = 'last_scratch_time'; // ğŸ›‘ á‹­áˆ„ field áŠ¨ "SCRATCH" áŠ á‹áˆ«áˆ­ áŒ‹áˆ­ áˆ˜áˆ˜áˆ³áˆ°áˆ áŠ áˆˆá‰ á‰µ
            const actionButton = document.getElementById('scratch-card-action');
            const messageEl = document.getElementById('scratch-result-message');
            const prizeTextEl = document.getElementById('scratch-prize-text');
            
            scratchCanvas = document.getElementById('scratch-canvas');
            scratchCtx = scratchCanvas.getContext('2d', { willReadFrequently: true }); // willReadFrequently áˆˆ checkScratchPercentage
            
            // á‹¨ Canvas áˆµá‹á‰µ áŠ¥áŠ“ á‰áˆ˜á‰µ áˆ›áˆµá‰°áŠ«áŠ¨áˆ
            scratchCanvas.width = scratchCanvas.clientWidth;
            scratchCanvas.height = scratchCanvas.clientHeight;
            scratchCanvas.style.opacity = '1'; // á‰°áˆ˜áˆáˆ¶ áŠ¥áŠ•á‹²á‰³á‹­ áˆ›á‹µáˆ¨áŒ
            scratchCanvas.style.transition = 'none'; // á‰µáˆ«áŠ•á‹šáˆ½áŠ‘áŠ• áˆ›áŒ½á‹³á‰µ

            // á‹¨áŒŠá‹œ áŒˆá‹°á‰¡áŠ• (Cooldown) áˆ›áˆ¨áŒ‹áŒˆáŒ¥
            const { isReady } = checkDailyLimit(timestampField);

            if (isReady || isReset) {
                // 1. áŒ¨á‹‹á‰³á‹ á‹áŒáŒ áŠá‹
                isScratchGameActive = true;
                
                // 2. á‹¨á‹˜áˆá‰€á‹° áˆ½áˆáˆ›á‰µ áˆ˜áˆáˆ¨áŒ¥
                scratchPrizeAmount = SCRATCH_PRIZES[Math.floor(Math.random() * SCRATCH_PRIZES.length)];
                prizeTextEl.innerHTML = `<span>+${scratchPrizeAmount.toLocaleString()} ğŸ’°</span>`;
                
                // 3. á‹¨áˆ˜áˆá‰…áˆá‰‚á‹«á‹áŠ• áˆ¸áˆ« (Canvas) áˆ˜áˆ™áˆ‹á‰µ
                // (áˆˆáˆáˆ³áˆŒ á‰ áŒáˆ«áŒ«áˆ› á‰€áˆˆáˆ)
                scratchCtx.globalCompositeOperation = 'source-over'; // á‹ˆá‹° áˆ˜á‹°á‰ áŠ› á‹¨áˆµáŠ¥áˆ áˆáŠ“á‰´ áˆ˜áˆ˜áˆˆáˆµ
                scratchCtx.fillStyle = '#AAAAAA'; // á‹¨áˆ˜áˆá‰…áˆá‰‚á‹«á‹ á‰€áˆˆáˆ
                scratchCtx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);
                // áŠ¨áˆ‹á‹­ áŒ½áˆá áˆ˜áŒ¨áˆ˜áˆ­ (áŠ áˆ›áˆ«áŒ­)
                scratchCtx.fillStyle = '#333333';
                scratchCtx.font = 'bold 20px Arial';
                scratchCtx.textAlign = 'center';
                scratchCtx.fillText('SCRATCH HERE', scratchCanvas.width / 2, scratchCanvas.height / 2 + 8);
                
                // 4. Event Listeners áˆ˜áŒ¨áˆ˜áˆ­ (á‹«áˆá‰°á‹°áŒˆáˆ™ áˆ˜áˆ†áŠ“á‰¸á‹áŠ• áˆ›áˆ¨áŒ‹áŒˆáŒ¥ áŠ á‹«áˆµáˆáˆáŒáˆá£ á‰  init áŒŠá‹œ á‰¥á‰» áŠá‹)
                scratchCanvas.addEventListener('mousedown', startScratch);
                scratchCanvas.addEventListener('mousemove', scratch);
                window.addEventListener('mouseup', stopScratch); // áˆ˜áˆµáŠ®á‰± áˆ‹á‹­
                
                scratchCanvas.addEventListener('touchstart', startScratch, { passive: false });
                scratchCanvas.addEventListener('touchmove', scratch, { passive: false });
                window.addEventListener('touchend', stopScratch);

                // 5. UI áˆ›áˆµá‰°áŠ«áŠ¨áˆ
                messageEl.innerText = 'áŠ«áˆ­á‹±áŠ• á‰ áˆ˜áˆá‰…áˆá‰… áˆ½áˆáˆ›á‰µá‹áŠ• á‹«áŒáŠ™!';
                actionButton.style.display = 'none'; // áŠ á‹áˆ«áˆ©áŠ• áˆ˜á‹°á‰ á‰…
                scratchCanvas.style.display = 'block'; // áˆ˜áˆá‰…áˆá‰‚á‹«á‹áŠ• áˆ›áˆ³á‹¨á‰µ

            } else {
                // 1. áŒ¨á‹‹á‰³á‹ á‹áŒáŒ áŠ á‹­á‹°áˆˆáˆ (Cooldown áˆ‹á‹­ áŠá‹)
                isScratchGameActive = false;
                
                // 2. áˆ˜áˆá‰…áˆá‰‚á‹«á‹áŠ• áˆ˜á‹°á‰ á‰… áŠ¥áŠ“ "áŠ áˆá‰‹áˆ" á‹¨áˆšáˆ áˆ›áˆ³á‹¨á‰µ
                scratchCanvas.style.display = 'none';
                prizeTextEl.innerHTML = '<span>ğŸš«<br>áˆˆá‹›áˆ¬ á‰°áŒ áŠ“á‰‹áˆ</span>';
                
                // 3. UI áˆ›áˆµá‰°áŠ«áŠ¨áˆ
                messageEl.innerText = 'áŒŠá‹œá‹ áŠ¥áˆµáŠªá‹«áˆá‰… á‹­áŒ á‰¥á‰á¢';
                actionButton.innerText = 'á‹ˆá‹° á‹‹áŠ“ áŒˆá… á‰°áˆ˜áˆˆáˆµ';
                actionButton.style.display = 'block';
                actionButton.disabled = false;
                actionButton.onclick = window.showMainPage;
            }
            
            // á‹¨áŒŠá‹œ á‰†áŒ£áˆªá‹áŠ• áˆ›áˆµáŒ€áˆ˜áˆ­ (á‹áŒáŒáˆ á‰£á‹­áˆ†áŠ•áˆ)
            startCooldownTimer(timestampField, 'scratch-card-timer', 'scratch-card-action');
        }
        
        // ======================================================================
        //                          SCRATCH CARD GAME CODE áˆ˜áŒ¨áˆ¨áˆ»
        // ======================================================================

        // ======================================================================
        //                          EXCHANGE PAGE CODE 
        // ======================================================================
        
        document.addEventListener('input', (event) => {
            if (event.target.id === 'exchangePointsInput') {
                const enteredPoints = parseInt(event.target.value); 
                const changeButton = document.getElementById('finalChangeButton');
                const availableScore = currentScore; 
                const requiredMinimum = 10000;

                const isValid = enteredPoints >= requiredMinimum && 
                                enteredPoints % 10000 === 0 &&
                                enteredPoints <= availableScore;

                if (isValid) {
                    changeButton.disabled = false;
                    changeButton.style.backgroundColor = 'var(--et-red)'; 
                    changeButton.style.cursor = 'pointer';
                } else {
                    changeButton.disabled = true;
                    changeButton.style.backgroundColor = '#a0a0a0';
                    changeButton.style.cursor = 'not-allowed';
                }
            }
        });

        document.addEventListener('click', async (event) => {
            if (event.target.id === 'finalChangeButton' && !event.target.disabled) {
                const pointsInput = document.getElementById('exchangePointsInput'); // ğŸ›‘ points
                const changeButton = document.getElementById('finalChangeButton');
                const exchangeMessage = document.getElementById('exchangeMessage');
                
                const pointsToExchange = parseInt(pointsInput.value); // ğŸ›‘ points
                
                changeButton.disabled = true;
                changeButton.innerText = 'áŒ¥á‹«á‰„ á‰ áˆ˜áˆ‹áŠ­ áˆ‹á‹­...';
                changeButton.style.backgroundColor = '#FF9800'; 

                if (currentUserDocData?.total_score >= pointsToExchange) { 
                     const success = await submitExchangeRequest(pointsToExchange); 
                     
                     if (success) {
                        await updateScore(pointsToExchange * -1, 'Coin Exchanged for Ticket Request'); 

                        exchangeMessage.style.color = 'var(--et-yellow)';
                        exchangeMessage.innerText = `âœ… á‹¨${pointsToExchange.toLocaleString()} coin áˆá‹á‹áŒ¥ áŒ¥á‹«á‰„á‹ á‹°áˆ­áˆ¶áŠ“áˆ! coiná‹ á‰°á‰€áŠ•áˆ·áˆá¢ á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹¨á‰²áŠ¬á‰µá‹ áˆ˜áŒ¨áˆ˜áˆ­ á‹­áŒ á‰¥á‰á¢`; // ğŸ›‘ áŠáŒ¥á‰¥ á‹ˆá‹° coin
                    } else {
                        exchangeMessage.style.color = '#F44336';
                        exchangeMessage.innerText = 'âŒ á‹­á‰…áˆ­á‰³ áŒ¥á‹«á‰„á‹ á‰°á‰€á‰£á‹­áŠá‰µ áŠ áˆ‹áŒˆáŠ˜áˆ: á‹­áˆ…áŠ• áŠ áŒˆáˆˆáŒáˆá‰µ á‰ á‰…áˆ­á‰¥ á‰€áŠ• á‹­á‰¥á‰á¢';
                    }
                } else {
                    exchangeMessage.style.color = '#F44336';
                    exchangeMessage.innerText = 'âŒ á‹­á‰…áˆ­á‰³ áŒ¥á‹«á‰„á‹ á‰°á‰€á‰£á‹­áŠá‰µ áŠ áˆ‹áŒˆáŠ˜áˆá¡ á‰ á‰‚ coin á‹¨áˆˆá‹á‰µáˆá¢'; 
                }
                
                changeButton.innerText = 'CHANGE';
                changeButton.style.backgroundColor = '#a0a0a0'; 
                pointsInput.value = '';
                
                setTimeout(() => {
                    exchangeMessage.innerText = '';
                }, 4000);
            }
        });

        async function submitExchangeRequest(coins) { 
            if (!currentFirebaseUserId || !currentUserDocData) return false;

            const requestRef = doc(db, 'exchange_requests', `${currentFirebaseUserId}_${Date.now()}`);
            
            try {
                await setDoc(requestRef, {
                    user_id: currentFirebaseUserId,
                    telegram_id: telegramUserId,
                    username: currentUserDocData.username || getTelegramUsername(),
                    points_requested: coins, 
                    status: 'Pending', 
                    submitted_at: serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error("Error submitting exchange request:", error);
                return false;
            }
        }
        
        // ======================================================================
        //                          EXCHANGE PAGE CODE áˆ˜áŒ¨áˆ¨áˆ»
        // ======================================================================


        // ======================================================================
        //                         MAIN RENDER FUNCTION
        // ======================================================================

        function renderPageContent() {
            // 1. coin áˆ›áˆ³á‹«á‹á‰½áŠ• á‰  Tasks áŠ¥áŠ“ Profile áŒˆáŒ¾á‰½ áˆ‹á‹­ áˆ›á‹˜áˆ˜áŠ•
            document.getElementById('tasks-score-display').innerText = currentScore.toLocaleString() + ' ğŸ’°'; // ğŸ›‘ score
            
            // 2. Profile Page
            const profileScoreDisplay = document.getElementById('profile-score-display');
            if (profileScoreDisplay) {
                profileScoreDisplay.innerText = currentScore.toLocaleString(); // ğŸ›‘ score
            }
            const profileTicketDisplay = document.getElementById('profile-ticket-display'); 
            if (profileTicketDisplay) {
                profileTicketDisplay.innerText = currentTickets.toLocaleString();
            }
            
            const profileBalanceValue = document.querySelector('.profile-stat-box .balance-value');
             if (profileBalanceValue) {
                // áˆˆáŒŠá‹œá‹ coináŠ• áŠ¥áŠ•á‹° áˆá‰µáŠ­ áŒˆáŠ•á‹˜á‰¥ áˆ›áˆ³á‹¨á‰µ (á‹ˆá‹­áˆ áŠ¥áŠ•á‹°áˆáˆˆáŒ‰á‰µ)
                const birrEquivalent = (currentScore / 1000).toFixed(2); // ğŸ›‘ score
                profileBalanceValue.innerText = `${birrEquivalent} á‰¥áˆ­`; 
            }

            // 3. Top Page (Leaderboard) áˆ‹á‹­ áˆ›á‹˜áˆ˜áŠ•
            document.getElementById('top-score-display').innerText = currentScore.toLocaleString() + ' ğŸ’°'; // ğŸ›‘ score
            document.getElementById('top-rank-display').innerText = currentRank; 

            // 4. á‹¨á‰°áŒ á‰ƒáˆš áˆµáˆ áŠ¥áŠ“ áŠ áˆáˆ³áˆ áˆ›áˆ³á‹«
            let username = 'á‰°áŒ«á‹‹á‰½';
            if (currentUserDocData?.username) {
                username = currentUserDocData.username;
            } else {
                 username = getTelegramUsername(); 
            }
            
            const usernameDisplay = document.getElementById('profile-username');
            if (usernameDisplay) {
                usernameDisplay.innerText = username;
            }
            
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                profileAvatar.innerHTML = getAvatarHtml(username, currentUserDocData?.photo_url); 
            }
            
            // 5. á‹¨á‰´áˆŒáŒáˆ«áˆ Main ButtonáŠ• áˆ˜á‰†áŒ£áŒ áˆ­
            const isTasksPage = document.getElementById('tasks-page')?.style.display === 'block';

            if (isTasksPage) {
                const { isReady } = checkDailyLimit('last_gift_time');
                if (isReady) {
                    WebApp.MainButton.setText(`ğŸ á‹•áˆˆá‰³á‹Š áˆµáŒ¦á‰³ (+10 coin)`); 
                    WebApp.MainButton.show();
                    WebApp.MainButton.setParams({ color: '#4CAF50', text_color: '#FFFFFF' });
                } else {
                    WebApp.MainButton.hide();
                }
            } else {
                 WebApp.MainButton.hide();
            }
            
            // ğŸ›‘ áŠ á‹²áˆµ: á‹¨áŠ«áˆ­á‹µ á‰£áŒ… áˆ›á‹˜áˆ˜áŠ•áŠ• áˆ›áˆµáŠ¬á‹µ
            if (isTasksPage && timerIntervals['card_status_update']) {
                updateTaskCardStatus('mystery-box-card', 'mystery-box-badge', 'last_mystery_time');
                updateTaskCardStatus('daily-spin-card', 'daily-spin-badge', 'last_spin_time');
                updateTaskCardStatus('reflex-game-card', 'reflex-game-badge', 'last_reflex_time');
                // ğŸ›‘ NEW: áˆˆ Slot Game Card
                updateTaskCardStatus('slots-game-card', 'slots-game-badge', SLOTS_COOLDOWN_FIELD);
            }
            
            // ğŸ›‘ NEW: Slot Game UI á‰ áŒˆáŒ¹ áˆ‹á‹­ áŠ«áˆˆ áˆ›á‹˜áˆ˜áŠ•
            if (document.getElementById('slots-game-page')?.style.display === 'block') {
                 window.updateSlotGameUI();
            }


        }


        // ======================================================================
        //                              INITIALIZATION
        // ======================================================================
        window.onload = async () => {
            WebApp.ready(); 
            WebApp.setHeaderColor('secondary_bg_color');
            
            
            WebApp.MainButton.onClick(async () => {
                const coinsToAdd = 200; // ğŸ›‘ score á‹ˆá‹° coins
                const { isReady } = checkDailyLimit('last_gift_time');
                if (!isReady) {
                    WebApp.showAlert(`âŒ á‹•áˆˆá‰³á‹Š áˆµáŒ¦á‰³ áˆˆ 24 áˆ°á‹“á‰µ á‰¥á‰» á‹­áˆ°áŒ£áˆá¢`);
                    return;
                }
                await updateScore(coinsToAdd, 'Daily Gift', 'last_gift_time');
            });
            
            await new Promise(resolve => { 
                onAuthStateChanged(auth, async (user) => {
                            // ğŸ›‘ === á‹¨á‰°áˆµá‰°áŠ«áŠ¨áˆˆá‹ áŠ­ááˆ (THE FIX) === ğŸ›‘
            // á‹¨á‰´áˆŒáŒáˆ«áˆ ID áˆ˜áŒ€áˆ˜áˆªá‹« áˆ˜áŒ«áŠ• áŠ áˆˆá‰ á‰µ (áˆˆáˆáˆ‰áˆ á‰°áŒ á‰ƒáˆš)
            try {
                if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                    telegramUserId = WebApp.initDataUnsafe.user.id.toString();
                } else {
                    // This is a fallback for testing in a browser
                    telegramUserId = 'TGMOCK-' + Math.floor(Math.random() * 10000); 
                }
                // Set the global variable for the "Copy" button
                window.telegramUserId = telegramUserId; 
            } catch (e) {
                console.error("CRITICAL: Failed to get Telegram User ID.", e);
                WebApp.showAlert("áˆµáˆ…á‰°á‰µ: á‹¨á‰´áˆŒáŒáˆ«áˆ áˆ˜áˆ¨áŒƒáŠ• áˆ›áŒáŠ˜á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢");
            }
            // ğŸ›‘ === áˆ›áˆµá‰°áŠ«áŠ¨á‹«á‹ áŠ¥á‹šáˆ… á‹«á‰ á‰ƒáˆ === ğŸ›‘

                    if (user) {
                        currentFirebaseUserId = user.uid;
                        setupLeaderboardListener(); 
                    } else {
                        await firebaseLogin(); 
                    }
                    resolve(); 
                });
            });
            
            switchPage('tasks-page'); 

            const loadingContainer = document.getElementById('loading-container');
            if (loadingContainer) {
                loadingContainer.style.opacity = '0';
                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                }, 500); 
            }
        };
    </script>
</body>
</html>
